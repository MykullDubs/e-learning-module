<!DOCTYPE html>
<html lang="en" class=""> <!-- The 'dark' class will be added here -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // CRITICAL: This script must be in the <head> of EVERY page
        // It prevents a flash of the wrong theme on page load.
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Toggle Switch Styles */
        .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label .toggle-ball { transform: translateX(100%); }
    </style>
</head>
<body class="bg-stone-50 dark:bg-gray-900 text-stone-800 dark:text-stone-200 transition-colors duration-300">

    <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-stone-200 dark:border-gray-700 sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 md:px-8 py-4 flex justify-between items-center">
             <a href="dashboard.html" class="text-xl font-bold text-stone-900 dark:text-white">Learning Experience Forge</a>
             <div class="flex items-center gap-6">
                 <!-- Notifications Bell -->
                 <div class="relative">
                    <button id="notifications-btn" class="relative">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-stone-500 dark:text-stone-400 hover:text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                        <span id="notifications-dot" class="hidden absolute top-0 right-0 h-2 w-2 bg-red-500 rounded-full"></span>
                    </button>
                    <div id="notifications-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-stone-200 dark:border-gray-700 overflow-hidden">
                        <div class="p-3 font-semibold text-sm border-b border-stone-200 dark:border-gray-700">Notifications</div>
                        <div id="notifications-list" class="max-h-96 overflow-y-auto">
                            <!-- JS will populate this -->
                        </div>
                    </div>
                 </div>

                 <!-- Profile Dropdown -->
                 <div class="relative">
                    <button id="profile-btn" class="flex items-center gap-2">
                        <span id="user-email-nav" class="text-sm text-stone-600 dark:text-stone-300 hidden sm:block"></span>
                        <div id="nav-avatar-container">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-stone-400 dark:text-stone-500" fill="currentColor" viewBox="0 0 16 16"><path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/><path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/></svg>
                        </div>
                    </button>
                    <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-stone-200 dark:border-gray-700 overflow-hidden">
                        <a href="grades.html" class="block px-4 py-2 text-sm text-stone-700 dark:text-stone-200 hover:bg-stone-100 dark:hover:bg-gray-700">My Grades</a>
                        <a href="settings.html" class="block px-4 py-2 text-sm text-stone-700 dark:text-stone-200 hover:bg-stone-100 dark:hover:bg-gray-700">Settings</a>
                        <div class="border-t border-stone-200 dark:border-gray-600"></div>
                        <button id="logout-btn" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-stone-100 dark:hover:bg-gray-700">Log Out</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 md:p-8 max-w-2xl">
        <header class="mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-stone-900 dark:text-white">Settings</h1>
            <p class="text-stone-500 dark:text-stone-400 mt-2 text-lg">Manage your account and preferences.</p>
        </header>

        <div class="space-y-12">
            <!-- Appearance Settings -->
            <section>
                <h2 class="text-xl font-bold border-b border-stone-200 dark:border-gray-700 pb-3 mb-6">Appearance</h2>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-stone-200 dark:border-gray-700 flex justify-between items-center">
                    <div>
                        <h3 class="font-semibold">Dark Mode</h3>
                        <p class="text-sm text-stone-500 dark:text-stone-400">Toggle between light and dark themes.</p>
                    </div>
                    <div>
                        <input type="checkbox" id="theme-toggle" class="toggle-checkbox hidden">
                        <label for="theme-toggle" class="toggle-label flex items-center cursor-pointer w-12 h-6 rounded-full p-1 transition duration-300 bg-gray-300 dark:bg-gray-600">
                            <div class="toggle-ball w-4 h-4 bg-white rounded-full shadow-md transform transition duration-300"></div>
                        </label>
                    </div>
                </div>
            </section>

             <!-- Profile Settings -->
             <section>
                <h2 class="text-xl font-bold border-b border-stone-200 dark:border-gray-700 pb-3 mb-6">Profile</h2>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-stone-200 dark:border-gray-700 space-y-6">
                    <!-- Profile Picture -->
                    <div class="flex items-center gap-6">
                        <img id="avatar-preview" src="https://placehold.co/96x96/E2E8F0/475569?text=Avatar" alt="Profile Picture" class="w-24 h-24 rounded-full object-cover border-4 border-white dark:border-gray-800 shadow-md">
                        <div>
                            <input type="file" id="file-input" class="hidden" accept="image/*">
                            <button id="change-pic-btn" class="px-4 py-2 bg-stone-200 dark:bg-gray-700 text-stone-800 dark:text-stone-200 font-semibold rounded-lg shadow-sm hover:bg-stone-300 dark:hover:bg-gray-600 transition">Change Picture</button>
                            <p class="text-xs text-stone-500 dark:text-stone-400 mt-2">JPG, PNG, or GIF. 5MB max.</p>
                        </div>
                    </div>
                    <!-- Display Name -->
                    <div>
                        <label for="display-name" class="block text-sm font-medium text-stone-700 dark:text-stone-300">Display Name</label>
                        <input type="text" id="display-name" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-stone-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="text-right pt-2">
                        <button id="update-profile-btn" class="px-5 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-sm hover:bg-indigo-700 transition">Save Profile</button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, writeBatch, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDWpBbBLpq2fOnN5-EO3kmc0CHyG7DHXIM",
            authDomain: "elearning-e83cb.firebaseapp.com",
            projectId: "elearning-e83cb",
            storageBucket: "elearning-e83cb.appspot.com",
            messagingSenderId: "25473938624",
            appId: "1:25473938624:web:5b56738933543f32a7e925",
            measurementId: "G-R713G5DD1S"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const storage = getStorage(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let selectedFile = null;
        let unreadNotifications = [];
        let unsubscribeNotifications = null;

        // --- Navbar Elements ---
        const logoutBtn = document.getElementById('logout-btn');
        const profileBtn = document.getElementById('profile-btn');
        const profileDropdown = document.getElementById('profile-dropdown');
        const notificationsBtn = document.getElementById('notifications-btn');
        const notificationsDropdown = document.getElementById('notifications-dropdown');
        const notificationsDot = document.getElementById('notifications-dot');
        const notificationsList = document.getElementById('notifications-list');

        // --- Page-specific Elements ---
        const themeToggle = document.getElementById('theme-toggle');
        const fileInput = document.getElementById('file-input');
        const changePicBtn = document.getElementById('change-pic-btn');
        const avatarPreview = document.getElementById('avatar-preview');
        const updateProfileBtn = document.getElementById('update-profile-btn');
        const displayNameInput = document.getElementById('display-name');


        // --- Auth Guard and User Info ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-email-nav').textContent = user.email;
                displayNameInput.value = user.displayName || '';
                
                const navAvatarContainer = document.getElementById('nav-avatar-container');
                if (user.photoURL) {
                    navAvatarContainer.innerHTML = `<img src="${user.photoURL}" class="w-8 h-8 rounded-full object-cover">`;
                    avatarPreview.src = user.photoURL;
                } else {
                    navAvatarContainer.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-stone-400 dark:text-stone-500" fill="currentColor" viewBox="0 0 16 16"><path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/><path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/></svg>`;
                }

                listenForNotifications(user.uid);

            } else {
                window.location.href = '/Login.html';
            }
        });

        // --- Universal Navbar Logic ---
        profileBtn.addEventListener('click', (e) => { e.stopPropagation(); profileDropdown.classList.toggle('hidden'); notificationsDropdown.classList.add('hidden'); });
        notificationsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            profileDropdown.classList.add('hidden');
            notificationsDropdown.classList.toggle('hidden');
            if (!notificationsDropdown.classList.contains('hidden')) {
                markNotificationsAsRead();
            }
        });
        window.addEventListener('click', () => {
            profileDropdown.classList.add('hidden');
            notificationsDropdown.classList.add('hidden');
        });
        logoutBtn.addEventListener('click', () => {
            if(unsubscribeNotifications) unsubscribeNotifications();
            signOut(auth);
        });
        
        // --- Universal Notifications Logic ---
        function listenForNotifications(userId) {
            const notificationsRef = collection(db, "notifications", userId, "userNotifications");
            const q = query(notificationsRef, orderBy("createdAt", "desc"));

            unsubscribeNotifications = onSnapshot(q, (snapshot) => {
                unreadNotifications = [];
                notificationsList.innerHTML = '';
                if (snapshot.empty) {
                    notificationsList.innerHTML = `<p class="p-4 text-sm text-stone-500 dark:text-stone-400">No new notifications.</p>`;
                    notificationsDot.classList.add('hidden');
                    return;
                }

                let hasUnread = false;
                snapshot.forEach(doc => {
                    const notification = { id: doc.id, ...doc.data() };
                    if (!notification.isRead) {
                        hasUnread = true;
                        unreadNotifications.push(doc.id);
                    }
                    displayNotification(notification);
                });
                notificationsDot.style.display = hasUnread ? 'block' : 'none';
            });
        }

        function displayNotification(notification) {
            const div = document.createElement('a');
            div.href = notification.link || '#';
            div.className = `block px-4 py-3 border-b border-stone-100 dark:border-gray-700 hover:bg-stone-50 dark:hover:bg-gray-700 ${!notification.isRead ? 'bg-indigo-50 dark:bg-indigo-900/20' : ''}`;
            const timeAgo = formatTimeAgo(notification.createdAt.toDate());
            div.innerHTML = `<p class="text-sm font-medium">${notification.message}</p><p class="text-xs text-stone-500 dark:text-stone-400 mt-1">${timeAgo}</p>`;
            notificationsList.appendChild(div);
        }

        async function markNotificationsAsRead() {
            if (unreadNotifications.length === 0 || !auth.currentUser) return;
            const batch = writeBatch(db);
            unreadNotifications.forEach(notificationId => {
                const notifRef = doc(db, "notifications", auth.currentUser.uid, "userNotifications", notificationId);
                batch.update(notifRef, { isRead: true });
            });
            await batch.commit();
            unreadNotifications = [];
        }

        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return Math.floor(seconds) + " seconds ago";
        }


        // --- Page-Specific Logic for Settings ---
        changePicBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                selectedFile = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => { avatarPreview.src = event.target.result; };
                reader.readAsDataURL(selectedFile);
            }
        });

        updateProfileBtn.addEventListener('click', async () => {
            if (!currentUser) return;
            
            updateProfileBtn.textContent = 'Saving...';
            updateProfileBtn.disabled = true;

            try {
                const nameToUpdate = displayNameInput.value;
                let photoURLToUpdate = currentUser.photoURL;

                if (selectedFile) {
                    const storageRef = ref(storage, `profile-pictures/${currentUser.uid}/${selectedFile.name}`);
                    const snapshot = await uploadBytes(storageRef, selectedFile);
                    photoURLToUpdate = await getDownloadURL(snapshot.ref);
                }

                await updateProfile(currentUser, {
                    displayName: nameToUpdate,
                    photoURL: photoURLToUpdate
                });

                alert('Profile updated successfully!');
                location.reload();

            } catch (error) {
                console.error("Error updating profile:", error);
                alert('Failed to update profile. Please try again.');
            } finally {
                updateProfileBtn.textContent = 'Save Profile';
                updateProfileBtn.disabled = false;
            }
        });
        
        // Correct Dark Mode Logic
        if (localStorage.getItem('theme') === 'dark') {
            themeToggle.checked = true;
        }

        themeToggle.addEventListener('change', () => {
            if (themeToggle.checked) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
        });
    </script>
</body>
</html>

