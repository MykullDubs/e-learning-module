<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Grades</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">

    <div id="loader" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <p class="text-lg">Loading Grades...</p>
    </div>

    <div id="app-content" class="hidden">
        <header class="bg-white shadow-sm border-b border-stone-200 sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 md:px-8 py-4 flex justify-between items-center">
                <a href="dashboard.html" class="text-xl font-bold text-stone-900">AI-Powered Web Dev</a>
                <div class="flex items-center gap-4">
                    <p id="user-email" class="text-sm text-stone-600 hidden sm:block"></p>
                    <button id="logout-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-semibold text-sm">Log Out</button>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-4 sm:p-6 md:p-8">
            <h2 class="text-3xl font-bold text-stone-900 mb-6">Your Grades</h2>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                <div id="grades-container" class="space-y-4">
                    <!-- Grades will be dynamically inserted here -->
                </div>
                <div id="no-grades-message" class="hidden text-center text-stone-500 py-8">
                    <p>You don't have any grades yet. Complete an assessment to see your results here.</p>
                </div>
                <div class="border-t mt-6 pt-4 flex justify-between items-center font-bold text-lg">
                    <span>Overall Grade</span>
                    <span id="overall-grade">--%</span>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK Scripts -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDWpBbBLpq2fOnN5-EO3kmc0CHyG7DHXIM",
        authDomain: "elearning-e83cb.firebaseapp.com",
        projectId: "elearning-e83cb",
        storageBucket: "elearning-e83cb.appspot.com",
        messagingSenderId: "25473938624",
        appId: "1:25473938624:web:5b56738933543f32a7e925",
        measurementId: "G-R713G5DD1S"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const loader = document.getElementById('loader');
      const appContent = document.getElementById('app-content');
      const userEmailEl = document.getElementById('user-email');
      const logoutBtn = document.getElementById('logout-btn');
      const gradesContainer = document.getElementById('grades-container');
      const noGradesMessage = document.getElementById('no-grades-message');
      const overallGradeEl = document.getElementById('overall-grade');

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          userEmailEl.textContent = user.email;
          await fetchGrades(user.uid);
          loader.style.display = 'none';
          appContent.classList.remove('hidden');
        } else {
          window.location.href = '/login.html';
        }
      });

      async function fetchGrades(userId) {
        try {
          const gradesRef = doc(db, 'grades', userId);
          const docSnap = await getDoc(gradesRef);

          if (docSnap.exists()) {
            const gradesData = docSnap.data();
            displayGrades(gradesData);
          } else {
            noGradesMessage.classList.remove('hidden');
            overallGradeEl.textContent = 'N/A';
          }
        } catch (error) {
          console.error("Error fetching grades: ", error);
          gradesContainer.innerHTML = `<p class="text-red-500">Could not load grades. Please try again later.</p>`;
        }
      }

      function displayGrades(grades) {
        gradesContainer.innerHTML = ''; // Clear previous content
        let totalScore = 0;
        let totalPossible = 0;
        
        for (const [key, value] of Object.entries(grades)) {
          if (key === 'module1_summative') {
            const gradeItem = document.createElement('div');
            gradeItem.className = 'flex justify-between items-center p-4 bg-stone-50 rounded-lg';
            gradeItem.innerHTML = `
              <span>Module 1 Summative Assessment</span>
              <span class="font-semibold">${value.score}%</span>
            `;
            gradesContainer.appendChild(gradeItem);
            totalScore += value.score;
            totalPossible += 100;
          }
          // Add more `if` blocks here for future quizzes
        }

        if (totalPossible > 0) {
          const overallPercentage = Math.round(totalScore / totalPossible * 100);
          overallGradeEl.textContent = `${overallPercentage}%`;
        } else {
          overallGradeEl.textContent = 'N/A';
        }
      }

      logoutBtn.addEventListener('click', () => {
        signOut(auth).then(() => window.location.href = '/login.html');
      });
    </script>
</body>
</html>
