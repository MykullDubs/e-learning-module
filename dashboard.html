<!DOCTYPE html>
<html lang="en" class=""> <!-- The 'dark' class will be added here -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // CRITICAL: This script must be in the <head> of EVERY page
        // It prevents a flash of the wrong theme on page load.
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .progress-ring-circle { transition: stroke-dashoffset 0.5s; transform: rotate(-90deg); transform-origin: 50% 50%; }
    </style>
</head>
<body class="bg-stone-50 dark:bg-gray-900 text-stone-800 dark:text-stone-200 transition-colors duration-300">

    <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-stone-200 dark:border-gray-700 sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 md:px-8 py-4 flex justify-between items-center">
             <a href="dashboard.html" class="text-xl font-bold text-stone-900 dark:text-white">Learning Experience Forge</a>
             <div class="flex items-center gap-6">
                 <!-- Notifications Bell -->
                 <div class="relative">
                    <button id="notifications-btn" class="relative">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-stone-500 dark:text-stone-400 hover:text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                        <span id="notifications-dot" class="hidden absolute top-0 right-0 h-2 w-2 bg-red-500 rounded-full"></span>
                    </button>
                    <div id="notifications-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-stone-200 dark:border-gray-700 overflow-hidden">
                        <div class="p-3 font-semibold text-sm border-b border-stone-200 dark:border-gray-700">Notifications</div>
                        <div id="notifications-list" class="max-h-96 overflow-y-auto">
                            <!-- JS will populate this -->
                        </div>
                    </div>
                 </div>

                 <!-- Profile Dropdown -->
                 <div class="relative">
                    <button id="profile-btn" class="flex items-center gap-2">
                        <span id="user-email-nav" class="text-sm text-stone-600 dark:text-stone-300 hidden sm:block"></span>
                        <div id="nav-avatar-container">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-stone-400 dark:text-stone-500" fill="currentColor" viewBox="0 0 16 16"><path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/><path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/></svg>
                        </div>
                    </button>
                    <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-stone-200 dark:border-gray-700 overflow-hidden">
                        <a href="grades.html" class="block px-4 py-2 text-sm text-stone-700 dark:text-stone-200 hover:bg-stone-100 dark:hover:bg-gray-700">My Grades</a>
                        <a href="settings.html" class="block px-4 py-2 text-sm text-stone-700 dark:text-stone-200 hover:bg-stone-100 dark:hover:bg-gray-700">Settings</a>
                        <div class="border-t border-stone-200 dark:border-gray-600"></div>
                        <button id="logout-btn" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-stone-100 dark:hover:bg-gray-700">Log Out</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 md:p-8">
        <header class="mb-10">
            <h1 id="welcome-message" class="text-3xl md:text-4xl font-bold text-stone-900 dark:text-white">Welcome!</h1>
            <p class="text-stone-500 dark:text-stone-400 mt-2 text-lg">Your learning journey continues here. Let's get started.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
            <!-- Main Content: Modules -->
            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-stone-200 dark:border-gray-700">
                    <h2 id="continue-learning-title" class="text-xl font-bold mb-4">Get Started Learning</h2>
                    <p id="continue-learning-desc" class="text-stone-600 dark:text-stone-300 mb-6">Begin with the first module to learn the fundamentals of prompting.</p>
                    <a id="continue-learning-btn" href="module1.html" class="inline-block px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition">
                        Start Module 1
                    </a>
                </div>
                
                <div>
                    <h2 class="text-2xl font-bold mb-4">Course Modules</h2>
                    <div id="modules-container" class="space-y-4">
                        <!-- Module items will be dynamically inserted here -->
                    </div>
                </div>
            </div>

            <!-- Sidebar: Progress -->
            <aside class="space-y-8">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-stone-200 dark:border-gray-700">
                    <h3 class="font-bold text-lg mb-4 text-center">Overall Progress</h3>
                    <div class="relative w-40 h-40 mx-auto">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="text-stone-200 dark:text-gray-700" stroke-width="10" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                            <circle id="progress-ring" class="progress-ring-circle text-indigo-600" stroke-width="10" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                        </svg>
                        <span id="progress-text" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-2xl font-bold">0%</span>
                    </div>
                </div>
                <a href="grades.html" class="block text-center bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-stone-200 dark:border-gray-700 hover:border-indigo-500 dark:hover:border-indigo-500 transition">
                    <h3 class="font-bold text-lg">My Grades</h3>
                </a>
                 <a href="module-discussions.html" class="block text-center bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-stone-200 dark:border-gray-700 hover:border-indigo-500 dark:hover:border-indigo-500 transition">
                    <h3 class="font-bold text-lg">Module Discussions</h3>
                </a>
            </aside>
        </div>
    </main>

     <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, onSnapshot, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDWpBbBLpq2fOnN5-EO3kmc0CHyG7DHXIM",
            authDomain: "elearning-e83cb.firebaseapp.com",
            projectId: "elearning-e83cb",
            storageBucket: "elearning-e83cb.appspot.com",
            messagingSenderId: "25473938624",
            appId: "1:25473938624:web:5b56738933543f32a7e925",
            measurementId: "G-R713G5DD1S"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Navbar Elements ---
        const logoutBtn = document.getElementById('logout-btn');
        const profileBtn = document.getElementById('profile-btn');
        const profileDropdown = document.getElementById('profile-dropdown');
        const notificationsBtn = document.getElementById('notifications-btn');
        const notificationsDropdown = document.getElementById('notifications-dropdown');
        const notificationsDot = document.getElementById('notifications-dot');
        const notificationsList = document.getElementById('notifications-list');
        
        let unreadNotifications = [];
        let unsubscribeNotifications = null;

        // --- Navbar Logic ---
        profileBtn.addEventListener('click', (e) => { e.stopPropagation(); profileDropdown.classList.toggle('hidden'); notificationsDropdown.classList.add('hidden'); });
        notificationsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            profileDropdown.classList.add('hidden');
            notificationsDropdown.classList.toggle('hidden');
            if (!notificationsDropdown.classList.contains('hidden')) {
                markNotificationsAsRead();
            }
        });
        window.addEventListener('click', () => {
            profileDropdown.classList.add('hidden');
            notificationsDropdown.classList.add('hidden');
        });
        logoutBtn.addEventListener('click', () => {
            if (unsubscribeNotifications) unsubscribeNotifications();
            signOut(auth);
        });
        
        // --- Auth Guard and Data Fetching ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('user-email-nav').textContent = user.email;
                const navAvatarContainer = document.getElementById('nav-avatar-container');
                if (user.photoURL) {
                   navAvatarContainer.innerHTML = `<img src="${user.photoURL}" class="w-8 h-8 rounded-full object-cover">`;
                }
                fetchUserProgress(user);
                listenForNotifications(user.uid);
            } else {
                window.location.href = '/Login.html';
            }
        });
        
        // --- Notifications Logic ---
        function listenForNotifications(userId) {
            const notificationsRef = collection(db, "notifications", userId, "userNotifications");
            const q = query(notificationsRef, orderBy("createdAt", "desc"));

            unsubscribeNotifications = onSnapshot(q, (snapshot) => {
                unreadNotifications = [];
                notificationsList.innerHTML = '';
                if (snapshot.empty) {
                    notificationsList.innerHTML = `<p class="p-4 text-sm text-stone-500 dark:text-stone-400">No new notifications.</p>`;
                    notificationsDot.classList.add('hidden');
                    return;
                }

                let hasUnread = false;
                snapshot.forEach(doc => {
                    const notification = { id: doc.id, ...doc.data() };
                    if (!notification.isRead) {
                        hasUnread = true;
                        unreadNotifications.push(doc.id);
                    }
                    displayNotification(notification);
                });

                if (hasUnread) {
                    notificationsDot.classList.remove('hidden');
                } else {
                    notificationsDot.classList.add('hidden');
                }
            });
        }

        function displayNotification(notification) {
            const div = document.createElement('a');
            div.href = notification.link || '#';
            div.className = `block px-4 py-3 border-b border-stone-100 dark:border-gray-700 hover:bg-stone-50 dark:hover:bg-gray-700 ${!notification.isRead ? 'bg-indigo-50 dark:bg-indigo-900/20' : ''}`;
            
            const timeAgo = formatTimeAgo(notification.createdAt.toDate());

            div.innerHTML = `
                <p class="text-sm font-medium">${notification.message}</p>
                <p class="text-xs text-stone-500 dark:text-stone-400 mt-1">${timeAgo}</p>
            `;
            notificationsList.appendChild(div);
        }

        async function markNotificationsAsRead() {
            if (unreadNotifications.length === 0 || !auth.currentUser) return;

            const batch = writeBatch(db);
            unreadNotifications.forEach(notificationId => {
                const notifRef = doc(db, "notifications", auth.currentUser.uid, "userNotifications", notificationId);
                batch.update(notifRef, { isRead: true });
            });

            await batch.commit();
            unreadNotifications = [];
        }

        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return Math.floor(seconds) + " seconds ago";
        }

        // --- Dashboard Logic ---
        const modules = [
            { id: 1, title: "Prompting Fundamentals", file: "module1.html" },
            { id: 2, title: "The Serverless Backend", file: "module2.html" },
            { id: 3, title: "Crafting the Learner's Journey", file: "module3.html" },
            { id: 4, title: "The Gateway to Learning", file: "module4.html" },
            { id: 5, title: "Closing the Loop", file: "module5.html" },
            { id: 6, title: "Authentic Assessment Design", file: "module6.html" },
            { id: 7, title: "The Gradebook & Data Persistence", file: "module7.html" },
            { id: 8, title: "Final Project: Capstone", file: "module8.html" },
        ];

        async function fetchUserProgress(user) {
            if (!user) return;
            document.getElementById('welcome-message').textContent = `Welcome, ${user.displayName || 'Learner'}!`;
            const progressRef = doc(db, "progress", user.uid);
            const docSnap = await getDoc(progressRef);

            if (docSnap.exists()) {
                renderDashboard(docSnap.data());
            } else {
                console.log("No progress document found for this user.");
                // Render a default state if needed
            }
        }

        function renderDashboard(progressData) {
            const modulesContainer = document.getElementById('modules-container');
            modulesContainer.innerHTML = ''; 

            let lastCompletedModule = 0;
            for(let i = 1; i <= 8; i++) {
                if (progressData[`module${i}_completed`]) {
                    lastCompletedModule = i;
                }
            }

            modules.forEach(module => {
                const isLocked = module.id > 1 && !progressData[`module${module.id}_unlocked`];
                const isCompleted = progressData[`module${module.id}_completed`];
                const isInProgress = progressData[`module${module.id}_unlocked`] && !isCompleted;
                
                const moduleElement = createModuleElement(module, { isLocked, isCompleted, isInProgress });
                modulesContainer.appendChild(moduleElement);
            });
            
            // Update "Continue Learning" card
            const nextModule = modules.find(m => m.id === lastCompletedModule + 1);
            const continueLearningTitle = document.getElementById('continue-learning-title');
            const continueLearningDesc = document.getElementById('continue-learning-desc');
            const continueLearningBtn = document.getElementById('continue-learning-btn');
            
            if (progressData.overall_progress > 0) {
                 continueLearningTitle.textContent = "Pick Up Where You Left Off";
            } else {
                 continueLearningTitle.textContent = "Get Started Learning";
            }

            if (nextModule) {
                continueLearningDesc.textContent = `You're ready for Module ${nextModule.id}: ${nextModule.title}`;
                continueLearningBtn.textContent = `Start Module ${nextModule.id}`;
                continueLearningBtn.href = nextModule.file;
            } else {
                continueLearningDesc.textContent = "You have completed all modules. Congratulations!";
                continueLearningBtn.textContent = "Review Course";
                continueLearningBtn.href = "#"; 
            }

            // Update progress circle
            const progress = progressData.overall_progress || 0;
            const progressRing = document.getElementById('progress-ring');
            const progressText = document.getElementById('progress-text');
            const radius = progressRing.r.baseVal.value;
            const circumference = radius * 2 * Math.PI;
            progressRing.style.strokeDasharray = `${circumference} ${circumference}`;
            const offset = circumference - progress / 100 * circumference;
            progressRing.style.strokeDashoffset = offset;
            progressText.textContent = `${Math.round(progress)}%`;
        }

         function createModuleElement(module, state) {
            const div = document.createElement('div');
            let statusHTML = '';
            let link = '#';
            let mainClasses = 'bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm border border-stone-200 dark:border-gray-700 flex items-center justify-between';
            let titleClasses = 'font-bold';

            if (state.isLocked) {
                statusHTML = `<span class="text-xs font-semibold text-stone-500">🔒 Locked</span>`;
                mainClasses += ' opacity-50';
            } else if (state.isCompleted) {
                statusHTML = `<span class="text-xs font-semibold text-green-600 dark:text-green-400">✅ Completed</span>`;
                link = module.file;
            } else if (state.isInProgress) {
                statusHTML = `<div class="w-full bg-stone-200 dark:bg-gray-700 rounded-full h-2.5">
                                <div class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                              </div>
                              <span class="text-xs font-semibold text-indigo-600 dark:text-indigo-400 ml-3">In Progress</span>`;
                link = module.file;
            }

            div.innerHTML = `
                <a href="${link}" class="${mainClasses} ${state.isLocked ? 'pointer-events-none' : ''}">
                    <div>
                        <p class="text-sm text-stone-500 dark:text-stone-400">Module ${module.id}</p>
                        <h3 class="${titleClasses}">${module.title}</h3>
                    </div>
                    <div class="flex items-center gap-3">
                        ${statusHTML}
                    </div>
                </a>`;
            return div;
        }

    </script>
</body>
</html>

