<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module Discussions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Theme loader script
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .reply-indent { margin-left: 2.5rem; }
    </style>
</head>
<body class="bg-stone-50 dark:bg-gray-900 text-stone-800 dark:text-stone-200 transition-colors duration-300">

    <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-stone-200 dark:border-gray-700 sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 md:px-8 py-4 flex justify-between items-center">
             <a href="dashboard.html" class="text-xl font-bold text-stone-900 dark:text-white">Learning Experience Forge</a>
             <div class="flex items-center gap-6">
                 <div class="relative">
                    <button id="notifications-btn" class="relative">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-stone-500 dark:text-stone-400 hover:text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                        <span id="notifications-dot" class="hidden absolute top-0 right-0 h-2 w-2 bg-red-500 rounded-full"></span>
                    </button>
                    <div id="notifications-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-stone-200 dark:border-gray-700 overflow-hidden">
                        <div class="p-3 font-semibold text-sm border-b border-stone-200 dark:border-gray-700">Notifications</div>
                        <div id="notifications-list" class="max-h-96 overflow-y-auto"></div>
                    </div>
                 </div>
                 <div class="relative">
                    <button id="profile-btn" class="flex items-center gap-2">
                        <span id="user-email-nav" class="text-sm text-stone-600 dark:text-stone-300 hidden sm:block"></span>
                        <div id="nav-avatar-container">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-stone-400 dark:text-stone-500" fill="currentColor" viewBox="0 0 16 16"><path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/><path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/></svg>
                        </div>
                    </button>
                    <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-stone-200 dark:border-gray-700 overflow-hidden">
                        <a href="grades.html" class="block px-4 py-2 text-sm text-stone-700 dark:text-stone-200 hover:bg-stone-100 dark:hover:bg-gray-700">My Grades</a>
                        <a href="settings.html" class="block px-4 py-2 text-sm text-stone-700 dark:text-stone-200 hover:bg-stone-100 dark:hover:bg-gray-700">Settings</a>
                        <div class="border-t border-stone-200 dark:border-gray-600"></div>
                        <button id="logout-btn" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-stone-100 dark:hover:bg-gray-700">Log Out</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <header class="mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-stone-900 dark:text-white">Module Discussions</h1>
            <p class="text-stone-500 dark:text-stone-400 mt-2 text-lg">Ask questions and collaborate with your peers.</p>
        </header>
        
        <div id="discussions-container" class="space-y-8">
            <div id="loading-state" class="text-center py-12">
                <p class="text-stone-500 dark:text-stone-400">Loading discussions...</p>
            </div>
        </div>
    </main>

     <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, onSnapshot, orderBy, writeBatch, addDoc, serverTimestamp, getDocs, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDWpBbBLpq2fOnN5-EO3kmc0CHyG7DHXIM",
            authDomain: "elearning-e83cb.firebaseapp.com",
            projectId: "elearning-e83cb",
            storageBucket: "elearning-e83cb.appspot.com",
            messagingSenderId: "25473938624",
            appId: "1:25473938624:web:5b56738933543f32a7e925",
            measurementId: "G-R713G5DD1S"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- All Element Declarations ---
        const logoutBtn = document.getElementById('logout-btn');
        const profileBtn = document.getElementById('profile-btn');
        const profileDropdown = document.getElementById('profile-dropdown');
        const notificationsBtn = document.getElementById('notifications-btn');
        const notificationsDropdown = document.getElementById('notifications-dropdown');
        const notificationsDot = document.getElementById('notifications-dot');
        const notificationsList = document.getElementById('notifications-list');
        const discussionsContainer = document.getElementById('discussions-container');
        
        let currentUser = null;
        let unsubscribeNotifications = null;

        // --- Main Auth Function ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-email-nav').textContent = user.email;
                const navAvatarContainer = document.getElementById('nav-avatar-container');
                if (user.photoURL) {
                   navAvatarContainer.innerHTML = `<img src="${user.photoURL}" class="w-8 h-8 rounded-full object-cover">`;
                }
                listenForNotifications(user.uid);
                fetchProgressAndDiscussions(user.uid);
            } else {
                window.location.href = '/Login.html';
            }
        });
        
        // --- Event Listeners ---
        profileBtn.addEventListener('click', (e) => { e.stopPropagation(); profileDropdown.classList.toggle('hidden'); notificationsDropdown.classList.add('hidden'); });
        notificationsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            profileDropdown.classList.add('hidden');
            notificationsDropdown.classList.toggle('hidden');
            if (!notificationsDropdown.classList.contains('hidden')) markNotificationsAsRead();
        });
        window.addEventListener('click', () => {
            profileDropdown.classList.add('hidden');
            notificationsDropdown.classList.add('hidden');
        });
        logoutBtn.addEventListener('click', () => {
            if (unsubscribeNotifications) unsubscribeNotifications();
            signOut(auth);
        });

        discussionsContainer.addEventListener('click', async (e) => {
            const postId = e.target.dataset.postId;
            if (!postId) return;

            if (e.target.classList.contains('delete-btn')) {
                if (confirm('Are you sure you want to delete this post?')) {
                    await deleteDoc(doc(db, "discussions", postId));
                }
            } else if (e.target.classList.contains('edit-btn')) {
                document.getElementById(`post-text-${postId}`).classList.add('hidden');
                const editForm = document.getElementById(`edit-form-${postId}`);
                editForm.classList.remove('hidden');
                editForm.querySelector('textarea').value = document.getElementById(`post-text-${postId}`).textContent;
            } else if (e.target.classList.contains('cancel-edit-btn')) {
                 document.getElementById(`post-text-${postId}`).classList.remove('hidden');
                 document.getElementById(`edit-form-${postId}`).classList.add('hidden');
            } else if (e.target.classList.contains('save-btn')) {
                const newText = document.getElementById(`edit-form-${postId}`).querySelector('textarea').value;
                if(newText) {
                    await updateDoc(doc(db, "discussions", postId), { text: newText });
                    document.getElementById(`post-text-${postId}`).classList.remove('hidden');
                    document.getElementById(`edit-form-${postId}`).classList.add('hidden');
                }
            } else if (e.target.classList.contains('reply-btn')) {
                handleReply(e);
            }
        });

        // --- Reusable Functions ---
        function listenForNotifications(userId) {
            const notificationsRef = collection(db, "notifications", userId, "userNotifications");
            const q = query(notificationsRef, orderBy("createdAt", "desc"));
            unsubscribeNotifications = onSnapshot(q, (snapshot) => {
                let unreadIds = [];
                notificationsList.innerHTML = '';
                if (snapshot.empty) {
                    notificationsList.innerHTML = `<p class="p-4 text-sm text-stone-500 dark:text-stone-400">No new notifications.</p>`;
                    notificationsDot.classList.add('hidden');
                    return;
                }
                let hasUnread = false;
                snapshot.forEach(doc => {
                    const notification = { id: doc.id, ...doc.data() };
                    if (!notification.isRead) { hasUnread = true; unreadIds.push(doc.id); }
                    displayNotification(notification);
                });
                notificationsDot.style.display = hasUnread ? 'block' : 'none';
            });
        }
        function displayNotification(notification) {
            const div = document.createElement('a');
            div.href = notification.link || '#';
            div.className = `block px-4 py-3 border-b border-stone-100 dark:border-gray-700 hover:bg-stone-50 dark:hover:bg-gray-700 ${!notification.isRead ? 'bg-indigo-50 dark:bg-indigo-900/20' : ''}`;
            const timeAgo = formatTimeAgo(notification.createdAt.toDate());
            div.innerHTML = `<p class="text-sm font-medium">${notification.message}</p><p class="text-xs text-stone-500 dark:text-stone-400 mt-1">${timeAgo}</p>`;
            notificationsList.appendChild(div);
        }
        async function markNotificationsAsRead() {
            if (!currentUser) return;
            const unreadIds = [];
            const notificationsRef = collection(db, "notifications", currentUser.uid, "userNotifications");
            const q = query(notificationsRef, where("isRead", "==", false));
            const snapshot = await getDocs(q);
            snapshot.forEach(doc => unreadIds.push(doc.id));

            if (unreadIds.length === 0) return;
            const batch = writeBatch(db);
            unreadIds.forEach(id => {
                const notifRef = doc(db, "notifications", currentUser.uid, "userNotifications", id);
                batch.update(notifRef, { isRead: true });
            });
            await batch.commit();
        }
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60; if (interval > 1) return Math.floor(interval) + " minutes ago";
            return Math.floor(seconds) + " seconds ago";
        }
        
        async function fetchProgressAndDiscussions(userId) {
            const progressRef = doc(db, "progress", userId);
            const docSnap = await getDoc(progressRef);

            let unlockedModules = ['welcome'];
            if (docSnap.exists()) {
                const progressData = docSnap.data();
                for (let i = 1; i <= 8; i++) {
                    if (progressData[`module${i}_unlocked`]) {
                        unlockedModules.push(`module${i}`);
                    }
                }
            }
            fetchDiscussions(unlockedModules);
        }

        function fetchDiscussions(unlockedModuleIds) {
            if (unlockedModuleIds.length === 0) {
                 document.getElementById('loading-state').classList.add('hidden');
                 discussionsContainer.innerHTML = '<p class="text-center text-stone-500">No discussions available yet.</p>';
                 return;
            }
            const discussionsRef = collection(db, "discussions");
            const q = query(discussionsRef, where("isParent", "==", true), where("moduleId", "in", unlockedModuleIds), orderBy("createdAt", "desc"));

            onSnapshot(q, (snapshot) => {
                document.getElementById('loading-state').classList.add('hidden');
                if (snapshot.empty) {
                    discussionsContainer.innerHTML = '<p class="text-center text-stone-500">No discussions available for your unlocked modules yet.</p>';
                    return;
                }

                discussionsContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    renderParentPost(doc.id, doc.data());
                });
            });
        }
        
        function renderParentPost(postId, postData) {
            const threadContainer = document.createElement('div');
            threadContainer.className = 'bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-stone-200 dark:border-gray-700';
            const time = postData.createdAt ? formatTimeAgo(postData.createdAt.toDate()) : 'just now';
            const moduleTitle = `Discussion for: ${postData.moduleId.replace('module', 'Module ').replace('welcome', 'Welcome')}`;

            let editDeleteControls = '';
            if (currentUser && postData.authorId === currentUser.uid) {
                editDeleteControls = `...`; // Redacted for brevity
            }

            threadContainer.innerHTML = `
                <div class="flex items-start gap-4">
                    <div class="w-10 h-10 bg-indigo-100 dark:bg-indigo-900 rounded-full flex items-center justify-center font-bold text-indigo-600 dark:text-indigo-300 text-lg flex-shrink-0">
                        ${postData.authorName.charAt(0)}
                    </div>
                    <div class="flex-grow">
                        <div class="flex items-center gap-3">
                            <p class="font-semibold">${postData.authorName}</p>
                            <p class="text-xs text-stone-500 dark:text-stone-400">${time}</p>
                            ${editDeleteControls}
                        </div>
                        <p class="text-sm text-stone-500 dark:text-stone-400">${moduleTitle}</p>
                        <div id="post-text-${postId}" class="mt-2 text-stone-700 dark:text-stone-300">${postData.text}</div>
                        <div id="edit-form-${postId}" class="hidden mt-2">
                            <textarea class="w-full p-2 border border-stone-300 rounded-md dark:bg-gray-700 dark:border-gray-600 text-sm">${postData.text}</textarea>
                            <div class="flex gap-2 mt-2">
                                <button class="save-btn text-xs px-3 py-1 bg-green-600 text-white rounded" data-post-id="${postId}">Save</button>
                                <button class="cancel-edit-btn text-xs px-3 py-1 bg-stone-200 dark:bg-gray-600 rounded" data-post-id="${postId}">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="replies-${postId}" class="mt-4 space-y-4 reply-indent"></div>
                <div class="mt-4 reply-indent">
                    <div class="flex items-center gap-2">
                         <input type="text" id="reply-input-${postId}" class="w-full bg-stone-100 dark:bg-gray-700 border-stone-200 dark:border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Write a reply...">
                         <button data-post-id="${postId}" data-author-id="${postData.authorId}" class="reply-btn px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg text-sm hover:bg-indigo-700 transition">Reply</button>
                    </div>
                </div>
            `;
            discussionsContainer.appendChild(threadContainer);
            fetchReplies(postId);
        }
        
        function fetchReplies(parentId) {
            const q = query(collection(db, "discussions"), where("parentId", "==", parentId), orderBy("createdAt", "asc"));
            onSnapshot(q, (snapshot) => {
                const repliesContainer = document.getElementById(`replies-${parentId}`);
                if (!repliesContainer) return;
                repliesContainer.innerHTML = '';
                snapshot.forEach(doc => renderReply(repliesContainer, doc.id, doc.data()));
            });
        }
        
        function renderReply(container, replyId, replyData) {
             const replyDiv = document.createElement('div');
             replyDiv.className = 'flex items-start gap-4';
             const time = replyData.createdAt ? formatTimeAgo(replyData.createdAt.toDate()) : 'just now';
             const initial = replyData.authorName.charAt(0);
             
             let editDeleteControls = '';
             if (currentUser && replyData.authorId === currentUser.uid) {
                editDeleteControls = `...`; // Redacted for brevity
             }

             replyDiv.innerHTML = `...`; // Redacted for brevity
             container.appendChild(replyDiv);
        }

        async function handleReply(event) {
            const parentId = event.target.dataset.postId;
            const originalPosterId = event.target.dataset.authorId;
            const input = document.getElementById(`reply-input-${parentId}`);
            const text = input.value.trim();
            if (!text || !currentUser) return;
            event.target.disabled = true;
            await addDoc(collection(db, "discussions"), {
                authorId: currentUser.uid,
                authorName: currentUser.displayName || currentUser.email,
                isParent: false,
                parentId: parentId,
                text: text,
                createdAt: serverTimestamp()
            });
            input.value = '';
            event.target.disabled = false;
            if (originalPosterId && originalPosterId !== currentUser.uid) {
                createNotification(originalPosterId, `${currentUser.displayName || 'A student'} replied to your post.`);
            }
        }
        
        async function createNotification(userId, message) {
            if (!userId) return;
            await addDoc(collection(db, "notifications", userId, "userNotifications"), {
                message: message, isRead: false, createdAt: serverTimestamp(), link: `/module-discussions.html`
            });
        }
     </script>
</body>
</html>

