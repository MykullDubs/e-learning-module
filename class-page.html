<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class - Golden Fellows English</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Source Serif Pro', serif;
            background-color: #F7F5F2;
        }
        .dark body {
            background-color: #0F172A;
        }
        .font-brand { font-family: 'Source Serif Pro', serif; }
        .widget-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .widget-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 0 15px 0 rgba(13, 148, 136, 0.2);
        }
        .dark .widget-card:hover {
             box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 0 25px 0 rgba(20, 184, 166, 0.2);
        }
        .flashcard-container {
            perspective: 1000px;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .flashcard.is-flipped {
            transform: rotateY(180deg);
        }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 1rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .flashcard-face-front {
            background-color: #fff;
            color: #172a3a;
        }
        .dark .flashcard-face-front {
            background-color: #1e293b;
            color: #d1d5db;
        }
        .flashcard-face-back {
            background-color: #2dd4bf;
            color: #fff;
            transform: rotateY(180deg);
        }
        .dark .flashcard-face-back {
            background-color: #0d9488;
        }
    </style>
</head>
<body class="text-gray-900 dark:text-gray-200 antialiased">

    <header class="bg-white/50 dark:bg-slate-900/50 backdrop-blur-sm shadow-sm border-b border-stone-200 dark:border-slate-800 sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 md:px-8 py-4 flex justify-between items-center">
            <a href="dashboard.html" class="text-xl font-bold font-brand text-gray-900 dark:text-white">Golden Fellows English</a>
            <a href="dashboard.html" class="text-sm font-semibold hover:text-indigo-600 dark:hover:text-indigo-400">Dashboard</a>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl font-brand">
        <header class="mb-8">
            <h1 id="class-title" class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white">Loading Class...</h1>
            <p id="class-description" class="text-gray-600 dark:text-gray-400 mt-2 text-lg"></p>
            <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                <span id="class-metadata"></span>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
            
            <div id="lesson-content-container" class="lg:col-span-2 space-y-8 bg-white/50 dark:bg-slate-800/50 backdrop-blur-lg p-8 rounded-2xl shadow-xl border border-stone-200/50 dark:border-slate-700/50">
                <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-200 pb-4 border-b border-stone-200 dark:border-slate-700">Today's Lesson</h2>
                <div id="unified-lesson-content" class="space-y-6">
                    <p class="text-gray-500 dark:text-gray-400">Loading lesson...</p>
                </div>
            </div>
            
            <aside class="lg:col-span-1 space-y-8">
                <section>
                    <div class="widget-card bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-stone-200 dark:border-slate-700">
                        <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">Weekly Vocabulary</h2>
                        <div id="flashcard-container" class="flashcard-container h-48">
                            <div id="flashcard" class="flashcard">
                                <div id="flashcard-front" class="flashcard-face flashcard-face-front">
                                    <p class="text-lg font-semibold text-gray-700 dark:text-gray-300">No words to display.</p>
                                </div>
                                <div id="flashcard-back" class="flashcard-face flashcard-face-back">
                                     <p class="text-base text-white">Definition & Example</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-between items-center">
                            <button id="prev-card-btn" class="text-gray-500 dark:text-gray-400 font-semibold text-sm hover:text-indigo-600 dark:hover:text-indigo-400 transition">← Previous</button>
                            <span id="flashcard-counter" class="text-sm font-semibold text-gray-500 dark:text-gray-400">0/0</span>
                            <button id="next-card-btn" class="text-indigo-600 dark:text-indigo-400 font-semibold text-sm hover:underline transition">Next →</button>
                        </div>
                    </div>
                </section>

                <section>
                    <div class="widget-card bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-stone-200 dark:border-slate-700">
                        <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">Assigned Quizzes</h2>
                        <div id="quizzes-list" class="space-y-4">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Loading quizzes...</p>
                        </div>
                    </div>
                </section>

                <section id="gradebook-widget">
                    <div class="widget-card bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-stone-200 dark:border-slate-700">
                        <h2 id="gradebook-widget-title" class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">Grades</h2>
                        <div id="gradebook-widget-content" class="space-y-3 max-h-60 overflow-y-auto">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Loading grades...</p>
                        </div>
                    </div>
                </section>

                <section>
                    <div class="widget-card bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-stone-200 dark:border-slate-700">
                        <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">Weekly Discussion</h2>
                        <div id="discussion-board" class="space-y-4">
                             <p class="text-sm text-gray-500 dark:text-gray-400">Loading discussion...</p>
                        </div>
                        <div class="mt-4">
                            <h3 class="font-semibold mb-2">Leave a comment:</h3>
                            <textarea id="comment-input" rows="3" class="w-full p-2 border rounded-lg bg-stone-50 dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring focus:border-indigo-500 transition"></textarea>
                            <button id="post-comment-btn" class="w-full mt-2 bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700 transition">Post Comment</button>
                        </div>
                    </div>
                </section>
            </aside>
        </div>
    </main>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, orderBy, onSnapshot, addDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDWpBbBLpq2fOnN5-EO3kmc0CHyG7DHXIM",
            authDomain: "elearning-e83cb.firebaseapp.com",
            projectId: "elearning-e83cb",
            storageBucket: "elearning-e83cb.appspot.com",
            messagingSenderId: "25473938624",
            appId: "1:25473938624:web:5b56738933543f32a7e925"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser, userData, classId, vocab = [], currentCardIndex = 0;

        function updateFlashcardUI() {
            const card = document.getElementById('flashcard');
            const front = document.getElementById('flashcard-front');
            const back = document.getElementById('flashcard-back');
            const counter = document.getElementById('flashcard-counter');

            if (vocab.length > 0) {
                const currentWord = vocab[currentCardIndex];
                front.innerHTML = `<p class="text-3xl font-bold">${currentWord.word}</p>`;
                back.innerHTML = `<p class="text-xl font-semibold">${currentWord.definition}</p><p class="mt-2 text-sm italic opacity-80">${currentWord.example}</p>`;
                counter.textContent = `${currentCardIndex + 1}/${vocab.length}`;
            } else {
                front.innerHTML = `<p class="text-lg font-semibold text-gray-700 dark:text-gray-300">No words to display.</p>`;
                back.innerHTML = `<p class="text-base text-white">Definition & Example</p>`;
                counter.textContent = `0/0`;
            }
            card.classList.remove('is-flipped');
        }

        document.getElementById('flashcard-container').addEventListener('click', () => { document.getElementById('flashcard').classList.toggle('is-flipped'); });
        document.getElementById('next-card-btn').addEventListener('click', (e) => { e.stopPropagation(); if (currentCardIndex < vocab.length - 1) { currentCardIndex++; updateFlashcardUI(); } });
        document.getElementById('prev-card-btn').addEventListener('click', (e) => { e.stopPropagation(); if (currentCardIndex > 0) { currentCardIndex--; updateFlashcardUI(); } });

        function renderLessonContent(lesson) {
            const contentContainer = document.getElementById('unified-lesson-content');
            let lessonHtml = '';
            vocab = [];

            if (!lesson || !lesson.contentBlocks || lesson.contentBlocks.length === 0) {
                contentContainer.innerHTML = `<p class="text-gray-500">No lesson content has been assigned yet.</p>`;
                return;
            }

            lesson.contentBlocks.forEach((block) => {
                switch(block.type) {
                    case 'title':
                        lessonHtml += `<h3 class="text-2xl font-bold text-gray-800 dark:text-gray-200">${block.text}</h3>`;
                        break;
                    case 'text':
                        lessonHtml += `<div class="text-gray-700 dark:text-gray-300 leading-relaxed"><p>${block.text.replace(/\n/g, '<br>')}</p></div>`;
                        break;
                    case 'grammar':
                        lessonHtml += `<div class="my-4 bg-indigo-50 dark:bg-indigo-900/50 p-4 rounded-lg"><p class="font-bold text-indigo-700 dark:text-indigo-200">${block.title}</p><p class="text-sm mt-1">${block.explanation}</p></div>`;
                        break;
                    case 'vocabulary':
                        if (block.isFlashcard) {
                            vocab.push({ word: block.word, definition: block.definition, example: block.example });
                        } else {
                            lessonHtml += `<div class="my-4 p-4 bg-stone-50 dark:bg-slate-900/50 rounded-lg border border-stone-200 dark:border-slate-700"><p class="font-bold text-lg">${block.word}</p><p class="text-sm text-gray-500 dark:text-gray-400">Definition: ${block.definition}</p><p class="text-sm text-gray-500 dark:text-gray-400 italic">Example: ${block.example}</p></div>`;
                        }
                        break;
                    case 'discussion-prompt':
                        lessonHtml += `<div class="my-6 p-4 border-l-4 border-teal-500 bg-teal-50 dark:bg-teal-900/30 rounded-r-lg"><p class="font-semibold text-teal-800 dark:text-teal-200">Discussion Prompt</p><p class="mt-2 text-gray-700 dark:text-gray-300 italic">"${block.prompt}"</p></div>`;
                        break;
                    case 'multiple-choice':
                        lessonHtml += `<div class="p-6 rounded-xl bg-white dark:bg-slate-900/50 shadow-md border border-stone-200 dark:border-slate-700" data-question-id="mc"><p class="font-semibold text-lg">${block.question}</p><div class="mt-4 space-y-2">${block.options.sort(() => Math.random() - 0.5).map(option => `<button onclick="checkMCAnswer(this, '${block.correctAnswer.replace(/'/g, "\\'")}')" class="w-full text-left p-3 border rounded-md hover:bg-stone-100 dark:hover:bg-slate-700 transition-colors">${option}</button>`).join('')}</div><div class="mt-3 text-sm font-semibold hidden"></div></div>`;
                        break;
                    case 'fill-in-the-blank':
                        lessonHtml += `<div class="p-6 rounded-xl bg-white dark:bg-slate-900/50 shadow-md border border-stone-200 dark:border-slate-700" data-question-id="fitb"><p class="font-semibold text-lg">Fill in the blank:</p><div class="mt-3 text-lg">${block.sentence.replace(/_/g, `<input type="text" data-correct-answer="${block.correctAnswer.replace(/'/g, "\\'")}" class="inline-block w-40 p-1 bg-transparent border-b-2 border-stone-300 dark:border-gray-600 focus:outline-none focus:border-indigo-500 mx-1">`)}</div><button onclick="checkFITBAnswer(this)" class="mt-4 bg-indigo-600 text-white font-semibold py-2 px-4 text-sm rounded-lg hover:bg-indigo-700">Check Answer</button><div class="mt-3 text-sm font-semibold hidden"></div></div>`;
                        break;
                }
            });

            contentContainer.innerHTML = lessonHtml || `<p class="text-gray-500">No content found for this lesson.</p>`;
            currentCardIndex = 0;
            updateFlashcardUI();
        }
        
        window.checkMCAnswer = (button, correctAnswer) => {
            const parent = button.closest('[data-question-id]');
            const feedbackEl = parent.querySelector('div:last-child');
            if (button.textContent.trim() === correctAnswer.trim()) {
                feedbackEl.textContent = '✅ Correct!';
                feedbackEl.className = 'mt-3 text-sm font-semibold text-green-600';
                parent.querySelectorAll('button').forEach(btn => {
                    btn.disabled = true;
                    if (btn.textContent.trim() !== correctAnswer.trim()) {
                        btn.classList.add('opacity-50');
                    }
                });
            } else {
                feedbackEl.textContent = '❌ Incorrect. The correct answer has been highlighted.';
                feedbackEl.className = 'mt-3 text-sm font-semibold text-red-500';
                 parent.querySelectorAll('button').forEach(btn => {
                    btn.disabled = true;
                    if (btn.textContent.trim() === correctAnswer.trim()) {
                        btn.classList.add('bg-green-100', 'dark:bg-green-900/50', 'border-green-500');
                    } else {
                        btn.classList.add('opacity-50');
                    }
                });
            }
        };

        window.checkFITBAnswer = (button) => {
            const parent = button.closest('[data-question-id]');
            const inputEl = parent.querySelector('input');
            const feedbackEl = parent.querySelector('div:last-child');
            if (inputEl.value.trim().toLowerCase() === inputEl.dataset.correctAnswer.trim().toLowerCase()) {
                feedbackEl.textContent = '✅ Correct!';
                feedbackEl.className = 'mt-3 text-sm font-semibold text-green-600';
            } else {
                feedbackEl.textContent = `❌ Incorrect. The correct answer is: ${inputEl.dataset.correctAnswer}`;
                feedbackEl.className = 'mt-3 text-sm font-semibold text-red-500';
            }
            inputEl.disabled = true;
            button.disabled = true;
        };

        async function fetchQuizzesForClass(classId) {
            const quizzesListEl = document.getElementById('quizzes-list');
            quizzesListEl.innerHTML = `<p class="text-sm text-gray-500">Loading quizzes...</p>`;
            const q = query(collection(db, "quizzes"), where("classId", "==", classId));
            const querySnapshot = await getDocs(q);

            quizzesListEl.innerHTML = '';
            if (querySnapshot.empty) {
                quizzesListEl.innerHTML = `<p class="text-sm text-gray-500">No quizzes are assigned.</p>`;
            } else {
                querySnapshot.forEach((doc) => {
                    const quizData = doc.data();
                    const quizLink = document.createElement('a');
                    quizLink.href = `quiz-player.html?quizId=${doc.id}&classId=${classId}`;
                    quizLink.className = 'block p-4 rounded-lg bg-stone-50 dark:bg-slate-900/50 hover:bg-stone-100 dark:hover:bg-slate-700 transition';
                    quizLink.innerHTML = `
                        <p class="font-semibold text-gray-800 dark:text-gray-200">${quizData.title}</p>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs text-gray-500 dark:text-gray-400">${quizData.questions.length} Questions</span>
                            <span class="text-sm font-semibold text-indigo-600 dark:text-indigo-400">Start Quiz →</span>
                        </div>
                    `;
                    quizzesListEl.appendChild(quizLink);
                });
            }
        }
        
        async function fetchAndRenderGradebookWidget(classId, user, userData) {
            const widgetContent = document.getElementById('gradebook-widget-content');
            const widgetTitle = document.getElementById('gradebook-widget-title');
            widgetContent.innerHTML = `<p class="text-sm text-gray-500">Loading grades...</p>`;
            let submissionsQuery;

            if (userData.role === 'instructor') {
                widgetTitle.textContent = 'Class Gradebook';
                submissionsQuery = query(collection(db, "submissions"), where("classId", "==", classId), orderBy("submittedAt", "desc"));
            } else {
                widgetTitle.textContent = 'My Grades for this Class';
                submissionsQuery = query(collection(db, "submissions"), where("classId", "==", classId), where("studentId", "==", user.uid), orderBy("submittedAt", "desc"));
            }

            try {
                const submissionSnap = await getDocs(submissionsQuery);
                const submissions = submissionSnap.docs.map(d => d.data());

                if (submissions.length === 0) {
                    widgetContent.innerHTML = `<p class="text-sm text-gray-500">No submissions found.</p>`;
                    return;
                }
                
                let studentMap = new Map();
                if (userData.role === 'instructor') {
                    const studentIds = [...new Set(submissions.map(s => s.studentId))];
                    if (studentIds.length > 0) {
                        const studentPromises = studentIds.map(id => getDoc(doc(db, "users", id)));
                        const studentDocs = await Promise.all(studentPromises);
                        studentDocs.forEach(doc => {
                            if (doc.exists()) {
                                studentMap.set(doc.id, doc.data().displayName || doc.data().email);
                            }
                        });
                    }
                }

                widgetContent.innerHTML = '';
                submissions.forEach(sub => {
                    const percentage = Math.round((sub.score / sub.totalQuestions) * 100);
                    const studentName = studentMap.get(sub.studentId) || '';
                    const gradeItem = document.createElement('div');
                    gradeItem.className = 'p-3 rounded-lg bg-stone-50 dark:bg-slate-900/50';
                    gradeItem.innerHTML = `
                        <div class="flex justify-between items-center">
                            <p class="font-semibold text-sm">${sub.quizTitle}</p>
                            <p class="font-bold text-sm ${percentage >= 70 ? 'text-green-600' : 'text-red-500'}">${percentage}%</p>
                        </div>
                        ${userData.role === 'instructor' ? `<p class="text-xs text-gray-500">${studentName}</p>` : ''}
                    `;
                    widgetContent.appendChild(gradeItem);
                });

            } catch (error) {
                console.error("Error fetching gradebook widget data: ", error);
                widgetContent.innerHTML = `<p class="text-sm text-red-500">Could not load grades.</p>`;
            }
        }

        async function loadClassContent(classId, user, userData) {
            const classDocRef = doc(db, "classes", classId);
            const classDocSnap = await getDoc(classDocRef);
            if (!classDocSnap.exists()) {
                document.getElementById('class-title').textContent = "Class Not Found";
                return;
            }

            const classData = classDocSnap.data();
            document.getElementById('class-title').textContent = classData.className;
            document.getElementById('class-description').textContent = classData.description;
            document.getElementById('class-metadata').innerHTML = `<span>Level: ${classData.cefrLevel || 'N/A'}</span> | <span>Teacher: ${classData.teacherName || 'N/A'}</span>`;

            const lessonsRef = collection(db, "classes", classId, "lessons");
            onSnapshot(query(lessonsRef), (snapshot) => {
                renderLessonContent(snapshot.docs.length > 0 ? snapshot.docs[0].data() : null);
            });
            
            const discussionsRef = collection(db, "classes", classId, "discussions");
            onSnapshot(query(discussionsRef, orderBy("timestamp", "desc")), (snapshot) => {
                const discussionBoardEl = document.getElementById('discussion-board');
                discussionBoardEl.innerHTML = '';
                if (snapshot.empty) {
                    discussionBoardEl.innerHTML = `<p class="text-sm text-gray-500">No comments yet.</p>`;
                } else {
                    snapshot.forEach(doc => {
                        const post = doc.data();
                        const postEl = document.createElement('div');
                        postEl.className = 'p-3 bg-stone-50 dark:bg-slate-900/50 rounded-lg';
                        postEl.innerHTML = `<p class="font-semibold">${post.authorName}</p><p class="text-sm">${post.text.replace(/\n/g, '<br>')}</p><p class="text-xs text-gray-400 mt-1">${post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString() : ''}</p>`;
                        discussionBoardEl.appendChild(postEl);
                    });
                }
            });

            document.getElementById('post-comment-btn').addEventListener('click', async () => {
                const commentInput = document.getElementById('comment-input');
                if (commentInput.value.trim() && currentUser) {
                    await addDoc(discussionsRef, { authorId: currentUser.uid, authorName: userData.displayName || currentUser.email, text: commentInput.value.trim(), timestamp: serverTimestamp() });
                    commentInput.value = '';
                }
            });

            await fetchQuizzesForClass(classId);
            await fetchAndRenderGradebookWidget(classId, user, userData);
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                try {
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    userData = docSnap.exists() ? docSnap.data() : { role: 'student' };
                } catch (error) {
                    console.error("Error fetching user data:", error);
                    userData = { role: 'student' };
                }

                const urlParams = new URLSearchParams(window.location.search);
                classId = urlParams.get('classId');
                if (classId) {
                    await loadClassContent(classId, currentUser, userData);
                } else {
                    document.getElementById('class-title').textContent = "No Class Selected";
                    document.getElementById('lesson-content-container').innerHTML = "<p class='text-center'>Please select a class from your dashboard.</p>";
                }
            } else {
                window.location.href = 'Login.html';
            }
        });
    </script>
</body>
</html>
