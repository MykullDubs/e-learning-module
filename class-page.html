<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class - Golden Fellows English</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Source Serif Pro', serif;
            background-color: #F7F5F2;
        }
        .dark body {
            background-color: #0F172A;
        }
        .font-brand { font-family: 'Source Serif Pro', serif; }
        .widget-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .widget-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 0 15px 0 rgba(13, 148, 136, 0.2);
        }
        .dark .widget-card:hover {
             box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 0 25px 0 rgba(20, 184, 166, 0.2);
        }
        .flashcard-container {
            perspective: 1000px;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .flashcard.is-flipped {
            transform: rotateY(180deg);
        }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 1rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .flashcard-face-front {
            background-color: #fff;
            color: #172a3a;
        }
        .dark .flashcard-face-front {
            background-color: #1e293b;
            color: #d1d5db;
        }
        .flashcard-face-back {
            background-color: #2dd4bf;
            color: #fff;
            transform: rotateY(180deg);
        }
        .dark .flashcard-face-back {
            background-color: #0d9488;
        }
        /* Prose style for markdown rendering */
        .prose :where(p):not(:where([class~="not-prose"] *)){margin-top:0;margin-bottom:0}
        .prose :where(ul):not(:where([class~="not-prose"] *)){margin-top:0;margin-bottom:0}
    </style>
</head>
<body class="text-gray-900 dark:text-gray-200 antialiased">

    <header class="bg-white/50 dark:bg-slate-900/50 backdrop-blur-sm shadow-sm border-b border-stone-200 dark:border-slate-800 sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 md:px-8 py-4 flex justify-between items-center">
            <a href="dashboard.html" class="text-xl font-bold font-brand text-gray-900 dark:text-white">Golden Fellows English</a>
            <a href="dashboard.html" class="text-sm font-semibold hover:text-indigo-600 dark:hover:text-indigo-400">Dashboard</a>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl font-brand">
        <header class="mb-8">
            <h1 id="class-title" class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white">Loading Class...</h1>
            <p id="class-description" class="text-gray-600 dark:text-gray-400 mt-2 text-lg"></p>
            <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                <span id="class-metadata"></span>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
            
            <div id="lesson-content-container" class="lg:col-span-2 space-y-8 bg-white/50 dark:bg-slate-800/50 backdrop-blur-lg p-8 rounded-2xl shadow-xl border border-stone-200/50 dark:border-slate-700/50">
                <section id="lesson-content">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-200">Lesson Content</h2>
                    <div id="lesson-text" class="prose dark:prose-invert max-w-none">
                        <p class="text-gray-500 dark:text-gray-400">No lessons assigned yet. Please contact your instructor.</p>
                    </div>
                </section>
                <section id="lesson-exercises" class="mt-8">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-200">Exercises</h2>
                    <div id="exercise-content" class="space-y-4">
                        <p class="text-gray-500 dark:text-gray-400">No exercises assigned for this lesson.</p>
                    </div>
                </section>
            </div>
            
            <aside class="lg:col-span-1 space-y-8">

                <section>
                    <div class="widget-card bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-stone-200 dark:border-slate-700">
                        <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">Weekly Vocabulary</h2>
                        <div id="flashcard-container" class="flashcard-container h-48">
                            <div id="flashcard" class="flashcard">
                                <div id="flashcard-front" class="flashcard-face flashcard-face-front p-6 flex flex-col justify-center items-center">
                                    <p class="text-lg font-semibold text-gray-700 dark:text-gray-300">No words to display.</p>
                                </div>
                                <div id="flashcard-back" class="flashcard-face flashcard-face-back p-6 flex flex-col justify-center items-center">
                                    <p class="text-base text-white">Definition & Example</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-between items-center">
                            <button id="prev-card-btn" class="text-gray-500 dark:text-gray-400 font-semibold text-sm hover:text-indigo-600 dark:hover:text-indigo-400 transition">← Previous</button>
                            <span id="flashcard-counter" class="text-sm font-semibold text-gray-500 dark:text-gray-400">0/0</span>
                            <button id="next-card-btn" class="text-indigo-600 dark:text-indigo-400 font-semibold text-sm hover:underline transition">Next →</button>
                        </div>
                        <button id="start-game-btn" class="w-full mt-4 bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700 hidden">
                            Start Flashcard Tic-Tac-Toe
                        </button>
                    </div>
                </section>

                <section>
                    <div class="widget-card bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-stone-200 dark:border-slate-700">
                        <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">Weekly Discussion</h2>
                        <div id="discussion-board" class="space-y-4">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Loading discussion posts...</p>
                        </div>
                        <div class="mt-4">
                            <h3 class="font-semibold mb-2">Leave a comment:</h3>
                            <textarea id="comment-input" rows="3" class="w-full p-2 border rounded-lg bg-stone-50 dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring focus:border-indigo-500 transition"></textarea>
                            <button id="post-comment-btn" class="w-full mt-2 bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700 transition">Post Comment</button>
                        </div>
                    </div>
                </section>
            </aside>
        </div>
    </main>
    
    <div id="game-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-xl w-full max-w-lg space-y-6">
            <h2 id="game-status-text" class="text-3xl font-bold text-center text-gray-900 dark:text-white"></h2>
            
            <div id="game-board" class="grid grid-cols-3 gap-2 w-full aspect-square bg-gray-200 dark:bg-slate-700 p-2 rounded-lg">
                <div class="game-cell flex items-center justify-center text-5xl font-bold rounded-lg cursor-pointer transition bg-white dark:bg-slate-800 hover:bg-stone-100 dark:hover:bg-slate-700" data-index="0"></div>
                <div class="game-cell flex items-center justify-center text-5xl font-bold rounded-lg cursor-pointer transition bg-white dark:bg-slate-800 hover:bg-stone-100 dark:hover:bg-slate-700" data-index="1"></div>
                <div class="game-cell flex items-center justify-center text-5xl font-bold rounded-lg cursor-pointer transition bg-white dark:bg-slate-800 hover:bg-stone-100 dark:hover:bg-slate-700" data-index="2"></div>
                <div class="game-cell flex items-center justify-center text-5xl font-bold rounded-lg cursor-pointer transition bg-white dark:bg-slate-800 hover:bg-stone-100 dark:hover:bg-slate-700" data-index="3"></div>
                <div class="game-cell flex items-center justify-center text-5xl font-bold rounded-lg cursor-pointer transition bg-white dark:bg-slate-800 hover:bg-stone-100 dark:hover:bg-slate-700" data-index="4"></div>
                <div class="game-cell flex items-center justify-center text-5xl font-bold rounded-lg cursor-pointer transition bg-white dark:bg-slate-800 hover:bg-stone-100 dark:hover:bg-slate-700" data-index="5"></div>
                <div class="game-cell flex items-center justify-center text-5xl font-bold rounded-lg cursor-pointer transition bg-white dark:bg-slate-800 hover:bg-stone-100 dark:hover:bg-slate-700" data-index="6"></div>
                <div class="game-cell flex items-center justify-center text-5xl font-bold rounded-lg cursor-pointer transition bg-white dark:bg-slate-800 hover:bg-stone-100 dark:hover:bg-slate-700" data-index="7"></div>
                <div class="game-cell flex items-center justify-center text-5xl font-bold rounded-lg cursor-pointer transition bg-white dark:bg-slate-800 hover:bg-stone-100 dark:hover:bg-slate-700" data-index="8"></div>
            </div>

            <div id="game-question-section" class="text-center space-y-4 hidden">
                <h3 id="question-text" class="text-2xl font-bold"></h3>
                <input type="text" id="answer-input" placeholder="Type your answer here..." class="w-full p-2 border rounded-lg bg-stone-50 dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring focus:border-indigo-500">
                <button id="submit-answer-btn" class="w-full bg-teal-600 text-white font-semibold py-2 rounded-lg hover:bg-teal-700">Submit Answer</button>
            </div>

            <div id="waiting-section" class="text-center space-y-4">
                <h3 class="text-xl font-bold">Waiting for another player to join...</h3>
                <p>Share this Game ID with a friend: <code id="waiting-game-id" class="text-xs bg-stone-100 dark:bg-slate-700 p-1 rounded"></code></p>
                <p>... or join an existing game.</p>
                <input type="text" id="join-game-input" placeholder="Enter Game ID to join" class="w-full p-2 border rounded-lg bg-stone-50 dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring focus:border-indigo-500">
                <button id="join-game-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700">Join Game</button>
            </div>
            
            <button id="close-game-btn" class="w-full mt-4 bg-gray-200 text-gray-800 font-semibold py-2 rounded-lg hover:bg-gray-300">Close Game</button>
        </div>
    </div>
    
    <script type="module">
        // Import all the necessary Firebase functions here
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, orderBy, onSnapshot, addDoc, updateDoc, arrayUnion, serverTimestamp, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDWpBbBLpq2fOnN5-EO3kmc0CHyG7DHXIM",
            authDomain: "elearning-e83cb.firebaseapp.com",
            projectId: "elearning-e83cb",
            storageBucket: "elearning-e83cb.appspot.com",
            messagingSenderId: "25473938624",
            appId: "1:25473938624:web:5b56738933543f32a7e925"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let classId = null;
        let currentLessonId = null;
        let currentGameId = null;
        let gameUnsubscribe = null;

        // Flashcard variables
        let vocab = [];
        let currentCardIndex = 0;

        // Function to update flashcard UI
        function updateFlashcardUI() {
            const card = document.getElementById('flashcard');
            const front = document.getElementById('flashcard-front');
            const back = document.getElementById('flashcard-back');
            const counter = document.getElementById('flashcard-counter');

            if (vocab.length > 0) {
                const currentWord = vocab[currentCardIndex];
                front.innerHTML = `<p class="text-3xl font-bold">${currentWord.word}</p>`;
                back.innerHTML = `<p class="text-xl font-semibold">${currentWord.definition}</p><p class="mt-2 text-sm italic opacity-80">${currentWord.example}</p>`;
                counter.textContent = `${currentCardIndex + 1}/${vocab.length}`;
            } else {
                front.innerHTML = `<p class="text-lg font-semibold text-gray-700 dark:text-gray-300">No words to display.</p>`;
                back.innerHTML = `<p class="text-base text-white">Definition & Example</p>`;
                counter.textContent = `0/0`;
            }
            card.classList.remove('is-flipped');
        }

        // Event listeners for flashcards
        document.getElementById('flashcard-container').addEventListener('click', () => {
            document.getElementById('flashcard').classList.toggle('is-flipped');
        });
        document.getElementById('next-card-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            if (currentCardIndex < vocab.length - 1) {
                currentCardIndex++;
                updateFlashcardUI();
            } else {
                alert("You've reached the end of the deck!");
            }
        });
        document.getElementById('prev-card-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            if (currentCardIndex > 0) {
                currentCardIndex--;
                updateFlashcardUI();
            } else {
                alert("You are at the start of the deck!");
            }
        });

        // Function to render the lesson content and exercises
        function renderLessonContent(lesson) {
            const lessonTextEl = document.getElementById('lesson-text');
            const exerciseContentEl = document.getElementById('exercise-content');
            let lessonTextHtml = '';
            let exerciseHtml = '';
            vocab = [];

            if (!lesson || !lesson.contentBlocks || lesson.contentBlocks.length === 0) {
                lessonTextEl.innerHTML = `<p class="text-gray-500 dark:text-gray-400">No lessons assigned yet. Please contact your instructor.</p>`;
                exerciseContentEl.innerHTML = `<p class="text-gray-500 dark:text-gray-400">No exercises assigned for this lesson.</p>`;
                document.getElementById('start-game-btn').classList.add('hidden');
                return;
            }

            lesson.contentBlocks.forEach((block, index) => {
                switch(block.type) {
                    case 'title':
                        lessonTextHtml += `<h2 class="text-3xl font-bold mb-4">${block.text}</h2>`;
                        break;
                    case 'grammar':
                        lessonTextHtml += `<div class="my-6 p-6 rounded-2xl bg-indigo-50 dark:bg-indigo-900/50 border border-indigo-200 dark:border-indigo-800 shadow-inner"><h3 class="font-bold text-indigo-700 dark:text-indigo-200">${block.title}</h3><p class="text-sm mt-2">${block.explanation}</p></div>`;
                        break;
                    case 'text':
                        lessonTextHtml += `<div class="mt-4 prose dark:prose-invert"><p>${block.text}</p></div>`;
                        break;
                    case 'vocabulary':
                        if (block.isFlashcard) {
                            vocab.push({ word: block.word, definition: block.definition, example: block.example });
                        }
                        break;
                    case 'multiple-choice':
                        // Render a multiple-choice question with validation
                        exerciseHtml += `
                            <div class="p-4 rounded-lg bg-white dark:bg-slate-700 shadow-sm" data-question-id="mc-${index}">
                                <p class="font-semibold text-gray-800 dark:text-gray-200">Multiple Choice:</p>
                                <p class="mt-1">${block.question}</p>
                                <div class="mt-2 space-y-2">
                                    ${block.options.map(option => `<button onclick="checkMCAnswer(this, '${block.correctAnswer.replace(/'/g, "\\'")}')" class="w-full text-left p-2 border rounded-md hover:bg-stone-100 dark:hover:bg-slate-600">${option}</button>`).join('')}
                                </div>
                                <div class="mt-2 text-sm font-semibold hidden"></div>
                            </div>
                        `;
                        break;
                    case 'fill-in-the-blank':
                        // Render a fill-in-the-blank question with input field
                        exerciseHtml += `
                            <div class="p-4 rounded-lg bg-white dark:bg-slate-700 shadow-sm" data-question-id="fitb-${index}">
                                <p class="font-semibold text-gray-800 dark:text-gray-200">Fill-in-the-Blank:</p>
                                <div class="mt-1">
                                    <span class="inline">${block.sentence.replace(/_/g, `<input type="text" data-correct-answer="${block.correctAnswer.replace(/'/g, "\\'")}" class="w-24 p-1 text-sm bg-transparent border-b-2 border-stone-300 dark:border-gray-600 focus:outline-none focus:border-indigo-500">`)}</span>
                                </div>
                                <button onclick="checkFITBAnswer(this)" class="mt-4 bg-indigo-600 text-white font-semibold py-2 px-4 text-sm rounded-lg hover:bg-indigo-700 transition">Check Answer</button>
                                <div class="mt-2 text-sm font-semibold hidden"></div>
                            </div>
                        `;
                        break;
                    case 'discussion-prompt':
                        // The discussion prompt is handled by the discussion board widget
                        break;
                    case 'video':
                        const videoId = block.url.split('v=')[1];
                        if (videoId) {
                            lessonTextHtml += `<div class="mt-4 aspect-w-16 aspect-h-9"><iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`;
                        }
                        break;
                    case 'quote':
                        lessonTextHtml += `<div class="relative pl-8 my-8 font-bold text-xl leading-relaxed italic"><span class="absolute top-0 left-0 text-gray-400 dark:text-gray-600 text-6xl leading-none">“</span><p class="ml-4">${block.text}</p><span class="absolute bottom-0 right-0 text-gray-400 dark:text-gray-600 text-6xl leading-none">”</span></div>`;
                        break;
                }
            });

            lessonTextEl.innerHTML = lessonTextHtml || `<p class="text-gray-500 dark:text-gray-400">No lesson content to display.</p>`;
            exerciseContentEl.innerHTML = exerciseHtml || `<p class="text-gray-500 dark:text-gray-400">No exercises assigned for this lesson.</p>`;

            if (vocab.length > 0) {
                document.getElementById('start-game-btn').classList.remove('hidden');
            } else {
                document.getElementById('start-game-btn').classList.add('hidden');
            }

            currentCardIndex = 0;
            updateFlashcardUI();
        }
        
        window.checkMCAnswer = (button, correctAnswer) => {
            const parent = button.closest('[data-question-id]');
            const feedbackEl = parent.querySelector('div:last-child');
            if (button.textContent.trim() === correctAnswer.trim()) {
                feedbackEl.textContent = '✅ Correct!';
                feedbackEl.classList.remove('hidden', 'text-red-600');
                feedbackEl.classList.add('text-green-600');
                parent.querySelectorAll('button').forEach(btn => btn.disabled = true);
            } else {
                feedbackEl.textContent = '❌ Incorrect. Try again.';
                feedbackEl.classList.remove('hidden', 'text-green-600');
                feedbackEl.classList.add('text-red-600');
            }
        };

        window.checkFITBAnswer = (button) => {
            const parent = button.closest('[data-question-id]');
            const inputEl = parent.querySelector('input');
            const feedbackEl = parent.querySelector('div:last-child');
            const userAnswer = inputEl.value.trim().toLowerCase();
            const correctAnswer = inputEl.dataset.correctAnswer.trim().toLowerCase();
            
            if (userAnswer === correctAnswer) {
                feedbackEl.textContent = '✅ Correct!';
                feedbackEl.classList.remove('hidden', 'text-red-600');
                feedbackEl.classList.add('text-green-600');
                inputEl.disabled = true;
                button.disabled = true;
            } else {
                feedbackEl.textContent = '❌ Incorrect. Try again.';
                feedbackEl.classList.remove('hidden', 'text-green-600');
                feedbackEl.classList.add('text-red-600');
            }
        };
        
        async function createGame() {
            if (!currentUser || !classId) {
                alert("You must be logged in and in a class to start a game.");
                return;
            }
            if (vocab.length < 9) {
                alert("You need at least 9 vocabulary words to play Tic-Tac-Toe.");
                return;
            }
        
            try {
                const lessonsRef = collection(db, "classes", classId, "lessons");
                const lessonsSnap = await getDocs(lessonsRef);
                const lessonId = lessonsSnap.docs[0]?.id;
                
                if (!lessonId) {
                    alert("No lesson assigned to this class.");
                    return;
                }
        
                const gamesRef = collection(db, "games");
                const newGameData = {
                    classId: classId,
                    lessonId: lessonId,
                    players: [currentUser.uid],
                    board: Array(9).fill({ value: '' }),
                    currentPlayer: currentUser.uid,
                    status: 'waiting_for_player',
                    flashcardQuestions: vocab,
                    createdAt: serverTimestamp()
                };
                
                const gameDocRef = doc(gamesRef);
                await setDoc(gameDocRef, newGameData);
                currentGameId = gameDocRef.id;
                
                document.getElementById('game-overlay').classList.remove('hidden');
                document.getElementById('game-overlay').classList.add('flex');
                document.getElementById('waiting-game-id').textContent = currentGameId;
                
                setupGameListener(currentGameId);
        
            } catch (error) {
                console.error("Error creating game:", error);
                alert("An error occurred while creating the game.");
            }
        }
        
        async function joinGame() {
            const gameId = document.getElementById('join-game-input').value.trim();
            if (!gameId) {
                alert("Please enter a valid game ID.");
                return;
            }
            if (!currentUser || !classId) {
                alert("You must be logged in and in a class to join a game.");
                return;
            }
        
            const gameRef = doc(db, "games", gameId);
            try {
                const gameDoc = await getDoc(gameRef);
                if (!gameDoc.exists()) {
                    alert("Game not found. Please check the ID.");
                    return;
                }
        
                const gameData = gameDoc.data();
                if (gameData.status !== 'waiting_for_player') {
                    alert("This game is already in progress or has finished.");
                    return;
                }
                if (gameData.players.includes(currentUser.uid)) {
                    alert("You are already in this game.");
                    return;
                }
                
                await updateDoc(gameRef, {
                    players: arrayUnion(currentUser.uid),
                    status: 'in_progress',
                });
        
                currentGameId = gameId;
                document.getElementById('game-overlay').classList.remove('hidden');
                document.getElementById('game-overlay').classList.add('flex');
                setupGameListener(currentGameId);
        
            } catch (error) {
                console.error("Error joining game:", error);
                alert("An error occurred while joining the game. The provided ID may be incorrect or you may not have the correct permissions.");
            }
        }
        
        function setupGameListener(gameId) {
            if (gameUnsubscribe) gameUnsubscribe();
        
            const gameRef = doc(db, "games", gameId);
            gameUnsubscribe = onSnapshot(gameRef, (doc) => {
                const game = doc.data();
                if (!game) {
                    console.log("Game ended.");
                    document.getElementById('game-overlay').classList.remove('flex');
                    document.getElementById('game-overlay').classList.add('hidden');
                    return;
                }
        
                if (game.status === 'in_progress') {
                    document.getElementById('waiting-section').classList.add('hidden');
                    document.getElementById('game-question-section').classList.remove('hidden');
                } else if (game.status === 'waiting_for_player') {
                    document.getElementById('waiting-section').classList.remove('hidden');
                    document.getElementById('game-question-section').classList.add('hidden');
                }
        
                game.board.forEach((cell, index) => {
                    document.querySelector(`[data-index="${index}"]`).textContent = cell.value;
                });
        
                if (game.status === 'in_progress') {
                    const playerNames = game.players.join(' vs ');
                    document.getElementById('game-status-text').textContent = `Game in Progress: ${playerNames}`;
                } else if (game.status === 'waiting_for_player') {
                    document.getElementById('game-status-text').textContent = `Waiting for Player...`;
                }
            });
        }
        
        document.getElementById('start-game-btn').addEventListener('click', createGame);
        document.getElementById('join-game-btn').addEventListener('click', joinGame);
        document.getElementById('close-game-btn').addEventListener('click', () => {
             if (gameUnsubscribe) gameUnsubscribe();
             document.getElementById('game-overlay').classList.remove('flex');
             document.getElementById('game-overlay').classList.add('hidden');
        });

        async function loadClassContent(classId) {
            const classDocRef = doc(db, "classes", classId);
            const classDocSnap = await getDoc(classDocRef);
            if (!classDocSnap.exists()) {
                document.getElementById('class-title').textContent = "Class Not Found";
                document.getElementById('lesson-text').innerHTML = "<p>The class you are looking for does not exist.</p>";
                return;
            }

            const classData = classDocSnap.data();
            document.getElementById('class-title').textContent = classData.className;
            document.getElementById('class-description').textContent = classData.description;
            document.getElementById('class-metadata').innerHTML = `
                ${classData.cefrLevel ? `<span>Level: ${classData.cefrLevel}</span>` : ''} 
                ${classData.teacherName ? `| <span>Teacher: ${classData.teacherName}</span>` : ''} 
                ${classData.classDay && classData.classTime ? `| <span>Schedule: ${classData.classDay}, ${classData.classTime}</span>` : ''}
            `;

            const lessonsRef = collection(db, "classes", classId, "lessons");
            const discussionsRef = collection(db, "classes", classId, "discussions");
            
            onSnapshot(query(lessonsRef), (snapshot) => {
                const lesson = snapshot.docs.length > 0 ? snapshot.docs[0].data() : null;
                currentLessonId = snapshot.docs[0]?.id;
                renderLessonContent(lesson);
            });
            
            onSnapshot(query(discussionsRef, orderBy("timestamp", "desc")), (snapshot) => {
                const discussionBoardEl = document.getElementById('discussion-board');
                discussionBoardEl.innerHTML = '';
                if (snapshot.empty) {
                    discussionBoardEl.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400">No comments yet. Be the first to start the discussion!</p>`;
                } else {
                    snapshot.forEach(doc => {
                        const post = doc.data();
                        const postEl = document.createElement('div');
                        postEl.className = 'p-3 bg-stone-50 dark:bg-slate-900/50 rounded-lg shadow-sm';
                        const postTime = post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString() : 'Just now';
                        postEl.innerHTML = `
                            <p class="font-semibold text-gray-800 dark:text-gray-200">${post.authorName}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${post.text}</p>
                            <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">${postTime}</p>
                        `;
                        discussionBoardEl.appendChild(postEl);
                    });
                }
            });

            document.getElementById('post-comment-btn').addEventListener('click', async () => {
                const commentInput = document.getElementById('comment-input');
                const text = commentInput.value.trim();
                if (text && currentUser) {
                    await addDoc(discussionsRef, {
                        authorId: currentUser.uid,
                        authorName: currentUser.displayName || currentUser.email,
                        text: text,
                        timestamp: serverTimestamp()
                    });
                    commentInput.value = '';
                }
            });
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const urlParams = new URLSearchParams(window.location.search);
                classId = urlParams.get('classId');
                if (classId) {
                    await loadClassContent(classId);
                } else {
                    document.getElementById('class-title').textContent = "No Class Selected";
                    document.getElementById('lesson-content-container').innerHTML = "<p class='text-gray-500 text-center mt-8'>Please return to your dashboard and select a class.</p>";
                }
            } else {
                window.location.href = 'Login.html';
            }
        });
    </script>
</body>
</html>
