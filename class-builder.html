<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Builder - Golden Fellows English</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">

    <script>
        // Theme loader script
    </script>
    
    <style>
        body { font-family: 'Source Serif Pro', serif; background-color: #F7F5F2; }
        .dark body { background-color: #0F172A; }
        .font-brand { font-family: 'Source Serif Pro', serif; }
    </style>
</head>
<body class="text-gray-900 dark:text-gray-200 antialiased">

    <header class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm shadow-sm border-b border-stone-200 dark:border-slate-800 sticky top-0 z-40">
        </header>

    <main class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl font-brand">
        <header class="mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white">Class Builder</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2 text-lg">Create learning paths and assign them to your students.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
            
            <aside class="lg:col-span-1 sticky top-24">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-stone-200/50 dark:border-slate-700/50">
                    <h2 class="text-2xl font-semibold mb-4">Your Classes</h2>
                    <div id="class-list" class="space-y-2"><p class="text-sm text-gray-500">Loading classes...</p></div>
                    <button id="create-class-btn" class="w-full mt-4 bg-teal-600 text-white font-semibold py-2 rounded-lg hover:bg-teal-700">+ Create New Class</button>
                </div>
            </aside>

            <div id="editor-panel" class="lg:col-span-2 space-y-8 hidden">
                <section>
                    <div class="bg-white/50 dark:bg-slate-800/50 backdrop-blur-lg p-8 rounded-2xl shadow-xl border border-stone-200/50 dark:border-slate-700/50">
                        <h2 id="editor-class-name" class="text-3xl font-bold mb-1"></h2>
                        <p class="text-gray-500 dark:text-gray-400 mb-6">Class ID: <code id="editor-class-id" class="text-xs bg-stone-100 dark:bg-slate-700 p-1 rounded"></code></p>
                        <hr class="my-6 border-stone-200 dark:border-slate-700">
                        <div>
                            <h3 class="text-2xl font-semibold mb-4 flex justify-between items-center">Assigned Lessons <button id="add-lesson-btn" class="bg-indigo-600 text-white font-semibold px-4 py-1 text-sm rounded-lg shadow-sm hover:bg-indigo-700">+ Add</button></h3>
                            <ul id="assigned-lessons-list" class="space-y-3"></ul>
                        </div>
                        <hr class="my-6 border-stone-200 dark:border-slate-700">
                        <div>
                            <h3 class="text-2xl font-semibold mb-4 flex justify-between items-center">Enrolled Students <button id="enroll-student-btn" class="bg-indigo-600 text-white font-semibold px-4 py-1 text-sm rounded-lg shadow-sm hover:bg-indigo-700">+ Enroll</button></h3>
                             <ul id="enrolled-students-list" class="space-y-3"></ul>
                        </div>
                    </div>
                </section>
            </div>
             <div id="editor-placeholder" class="lg:col-span-2 flex items-center justify-center h-96 bg-stone-50 dark:bg-slate-800/50 rounded-2xl border-2 border-dashed border-stone-300 dark:border-slate-700">
                <p class="text-gray-500 font-semibold">Select a class on the left or create a new one.</p>
            </div>
        </div>
    </main>

    <div id="add-lesson-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">Add a Lesson to the Class</h2>
            <div id="all-lessons-list" class="max-h-96 overflow-y-auto space-y-2"></div>
            <button id="close-lesson-modal-btn" class="w-full mt-4 bg-stone-200 dark:bg-slate-700 font-semibold py-2 rounded-lg">Cancel</button>
        </div>
    </div>
    <div id="enroll-student-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">Enroll a Student</h2>
            <div id="all-students-list" class="max-h-96 overflow-y-auto space-y-2"></div>
            <button id="close-student-modal-btn" class="w-full mt-4 bg-stone-200 dark:bg-slate-700 font-semibold py-2 rounded-lg">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, addDoc, serverTimestamp, getDocs, getDoc, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDWpBbBLpq2fOnN5-EO3kmc0CHyG7DHXIM",
            authDomain: "elearning-e83cb.firebaseapp.com",
            projectId: "elearning-e83cb",
            storageBucket: "elearning-e83cb.appspot.com",
            messagingSenderId: "25473938624",
            appId: "1:25473938624:web:5b56738933543f32a7e925"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let activeClassId = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userDocRef);
                if (!docSnap.exists() || docSnap.data().role !== 'instructor') {
                    window.location.href = 'dashboard.html';
                } else {
                    fetchClasses(user.uid);
                }
            } else {
                window.location.href = 'Login.html';
            }
        });

        async function fetchClasses(instructorId) {
            const classListEl = document.getElementById('class-list');
            classListEl.innerHTML = '<p class="text-sm text-gray-500">Loading...</p>';
            const q = query(collection(db, "classes"), where("instructorId", "==", instructorId), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            
            classListEl.innerHTML = '';
            querySnapshot.forEach((doc) => {
                const classData = doc.data();
                const classEl = document.createElement('a');
                classEl.href = `#${doc.id}`;
                classEl.className = 'block p-3 rounded-lg hover:bg-stone-100 dark:hover:bg-slate-700';
                classEl.innerHTML = `<p class="font-semibold">${classData.className}</p>`;
                classEl.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('#class-list a').forEach(a => a.classList.remove('bg-indigo-100', 'dark:bg-indigo-900/50', 'border-l-4', 'border-indigo-500'));
                    classEl.classList.add('bg-indigo-100', 'dark:bg-indigo-900/50', 'border-l-4', 'border-indigo-500');
                    loadClassForEditing(doc.id, classData);
                });
                classListEl.appendChild(classEl);
            });
        }

        function loadClassForEditing(classId, classData) {
            activeClassId = classId;
            document.getElementById('editor-placeholder').classList.add('hidden');
            document.getElementById('editor-panel').classList.remove('hidden');
            document.getElementById('editor-class-name').textContent = classData.className;
            document.getElementById('editor-class-id').textContent = classId;

            const assignedLessonsList = document.getElementById('assigned-lessons-list');
            onSnapshot(query(collection(db, "classes", classId, "lessons"), orderBy("order")), (snapshot) => {
                assignedLessonsList.innerHTML = '<li><p class="text-sm text-gray-500">No lessons assigned.</p></li>';
                if(!snapshot.empty) assignedLessonsList.innerHTML = '';
                snapshot.forEach(doc => {
                    const lesson = doc.data();
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-stone-50 dark:bg-slate-900/50 p-3 rounded-lg';
                    li.innerHTML = `<span>${lesson.order}. <b>${lesson.level}:</b> ${lesson.title}</span><button class="text-red-500 text-sm font-semibold">Remove</button>`;
                    assignedLessonsList.appendChild(li);
                });
            });

            const enrolledStudentsList = document.getElementById('enrolled-students-list');
            onSnapshot(query(collection(db, "classes", classId, "students")), (snapshot) => {
                enrolledStudentsList.innerHTML = '<li><p class="text-sm text-gray-500">No students enrolled.</p></li>';
                if(!snapshot.empty) enrolledStudentsList.innerHTML = '';
                snapshot.forEach(doc => {
                    const student = doc.data();
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-stone-50 dark:bg-slate-900/50 p-3 rounded-lg';
                    li.innerHTML = `<div class="flex items-center gap-3"><img src="${student.photoURL || `https://ui-avatars.com/api/?name=${student.displayName}`}" class="w-8 h-8 rounded-full"><span>${student.displayName}</span></div><button class="text-red-500 text-sm font-semibold">Unenroll</button>`;
                    enrolledStudentsList.appendChild(li);
                });
            });
        }

        async function createClass() {
            if (!currentUser) return;
            const className = prompt("Enter a name for your new class (e.g., B1 Intermediate Group):");
            if (!className) return;
            try {
                await addDoc(collection(db, "classes"), {
                    className: className, instructorId: currentUser.uid, instructorName: currentUser.displayName || currentUser.email, createdAt: serverTimestamp()
                });
                fetchClasses(currentUser.uid);
            } catch (error) { console.error("Error creating class:", error); }
        }

        async function addLessonToClass(lessonId, lessonData) {
            if(!activeClassId) return;
            const lessonRef = doc(db, "classes", activeClassId, "lessons", lessonId);
            const q = query(collection(db, "classes", activeClassId, "lessons"));
            const existingLessons = await getDocs(q);
            const newOrder = existingLessons.size + 1;
            await setDoc(lessonRef, { title: lessonData.title, level: lessonData.level, order: newOrder });
        }

        async function enrollStudentInClass(studentId, studentData) {
            if(!activeClassId) return;
            const studentInClassRef = doc(db, "classes", activeClassId, "students", studentId);
            await setDoc(studentInClassRef, { displayName: studentData.displayName, photoURL: studentData.photoURL || '' });
            const userDocRef = doc(db, "users", studentId);
            await updateDoc(userDocRef, { currentClassId: activeClassId });
        }

        const addLessonModal = document.getElementById('add-lesson-modal');
        const enrollStudentModal = document.getElementById('enroll-student-modal');

        document.getElementById('add-lesson-btn').addEventListener('click', async () => {
            if(!activeClassId) { alert("Please select a class first."); return; }
            const list = document.getElementById('all-lessons-list');
            list.innerHTML = 'Loading...';
            const lessonsSnap = await getDocs(query(collection(db, "lessons"), orderBy("level")));
            list.innerHTML = '';
            lessonsSnap.forEach(doc => {
                const lesson = doc.data();
                const btn = document.createElement('button');
                btn.className = 'w-full text-left p-2 rounded-md hover:bg-stone-100 dark:hover:bg-slate-700';
                btn.innerHTML = `<b>${lesson.level}</b>: ${lesson.title}`;
                btn.onclick = () => { addLessonToClass(doc.id, lesson); addLessonModal.classList.add('hidden'); };
                list.appendChild(btn);
            });
            addLessonModal.classList.remove('hidden');
        });

        document.getElementById('enroll-student-btn').addEventListener('click', async () => {
            if(!activeClassId) { alert("Please select a class first."); return; }
            const list = document.getElementById('all-students-list');
            list.innerHTML = 'Loading...';
            const studentsSnap = await getDocs(query(collection(db, "users"), where("role", "==", "student")));
            list.innerHTML = '';
            studentsSnap.forEach(doc => {
                const student = doc.data();
                const btn = document.createElement('button');
                btn.className = 'w-full text-left p-2 rounded-md hover:bg-stone-100 dark:hover:bg-slate-700 flex items-center gap-3';
                btn.innerHTML = `<img src="${student.photoURL || `https://ui-avatars.com/api/?name=${student.displayName}`}" class="w-8 h-8 rounded-full"><span>${student.displayName}</span>`;
                btn.onclick = () => { enrollStudentInClass(doc.id, student); enrollStudentModal.classList.add('hidden'); };
                list.appendChild(btn);
            });
            enrollStudentModal.classList.remove('hidden');
        });

        document.getElementById('close-lesson-modal-btn').addEventListener('click', () => addLessonModal.classList.add('hidden'));
        document.getElementById('close-student-modal-btn').addEventListener('click', () => enrollStudentModal.classList.add('hidden'));
        document.getElementById('create-class-btn').addEventListener('click', createClass);
    </script>
</body>
</html>
