<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Builder - Golden Fellows English</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com/">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Source Serif Pro', serif; background-color: #F7F5F2; }
        .dark body { background-color: #0F172A; }
        .font-brand { font-family: 'Source Serif Pro', serif; }
    </style>
</head>
<body class="text-gray-900 dark:text-gray-200 antialiased">

    <header class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm shadow-sm border-b border-stone-200 dark:border-slate-800 sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 md:px-8 py-4 flex justify-between items-center">
            <a href="dashboard.html" class="text-xl font-bold font-brand text-gray-900 dark:text-white">Golden Fellows English</a>
            <a href="dashboard.html" class="text-sm font-semibold hover:text-indigo-600 dark:hover:text-indigo-400">Dashboard</a>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl font-brand">
        <header class="mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white">Class Builder</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2 text-lg">Create learning paths and assign them to your students.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
            
            <aside class="lg:col-span-1 sticky top-24">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-stone-200/50 dark:border-slate-700/50">
                    <h2 class="text-2xl font-semibold mb-4">Your Classes</h2>
                    <div id="class-list" class="space-y-2"></div>
                    <button id="create-class-btn" class="w-full mt-4 bg-teal-600 text-white font-semibold py-2 rounded-lg hover:bg-teal-700">
                        + Create New Class
                    </button>
                </div>
            </aside>

            <div id="editor-panel" class="lg:col-span-2 space-y-8 hidden">
                <section>
                    <form id="class-form" class="bg-white/50 dark:bg-slate-800/50 backdrop-blur-lg p-8 rounded-2xl shadow-xl border border-stone-200/50 dark:border-slate-700/50">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-3xl font-bold">Edit Class</h2>
                            <button type="button" id="delete-class-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">Delete Class</button>
                        </div>
                        <p class="text-gray-500 dark:text-gray-400 mb-6">Class ID: <code id="editor-class-id" class="text-xs bg-stone-100 dark:bg-slate-700 p-1 rounded"></code></p>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="className" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Class Title</label>
                                <input type="text" id="className" name="className" required class="w-full p-2 border rounded-lg bg-stone-50 dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring focus:border-indigo-500 transition">
                            </div>
                            <div>
                                <label for="classDescription" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Class Description</label>
                                <textarea id="classDescription" name="classDescription" rows="4" class="w-full p-2 border rounded-lg bg-stone-50 dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring focus:border-indigo-500 transition"></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="classLevel" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">CEFR Level</label>
                                    <select id="classLevel" name="classLevel" required class="w-full p-2 border rounded-lg bg-stone-50 dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring focus:border-indigo-500 transition">
                                        <option value="">Select Level</option>
                                        <option value="A1">A1</option>
                                        <option value="A2">A2</option>
                                        <option value="B1">B1</option>
                                        <option value="B2">B2</option>
                                        <option value="C1">C1</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="classDay" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Class Day</label>
                                    <select id="classDay" name="classDay" required class="w-full p-2 border rounded-lg bg-stone-50 dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring focus:border-indigo-500 transition">
                                        <option value="">Select Day</option>
                                        <option value="Monday">Monday</option>
                                        <option value="Tuesday">Tuesday</option>
                                        <option value="Wednesday">Wednesday</option>
                                        <option value="Thursday">Thursday</option>
                                        <option value="Friday">Friday</option>
                                        <option value="Saturday">Saturday</option>
                                        <option value="Sunday">Sunday</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label for="classTime" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Class Time</label>
                                <input type="text" id="classTime" name="classTime" placeholder="e.g., 9:00 AM - 1:00 PM" class="w-full p-2 border rounded-lg bg-stone-50 dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring focus:border-indigo-500 transition">
                            </div>
                            <div>
                                <label for="teacherName" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Teacher's Name</label>
                                <input type="text" id="teacherName" name="teacherName" class="w-full p-2 border rounded-lg bg-stone-50 dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring focus:border-indigo-500 transition">
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full mt-6 bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700 transition">Save Class</button>
                    </form>
                </section>
                <hr class="my-6 border-stone-200 dark:border-slate-700">
                <section>
                    <div>
                        <h3 class="text-2xl font-semibold mb-4 flex justify-between items-center">Assigned Lessons
                            <a href="class-lessons-library.html" class="bg-indigo-600 text-white font-semibold px-4 py-1 text-sm rounded-lg shadow-sm hover:bg-indigo-700 transition">
                                + Add
                            </a>
                        </h3>
                        <ul id="assigned-lessons-list" class="space-y-3"></ul>
                    </div>
                </section>
                <hr class="my-6 border-stone-200 dark:border-slate-700">
                <section>
                    <div>
                        <h3 class="text-2xl font-semibold mb-4 flex justify-between items-center">Enrolled Students
                            <button id="enroll-student-btn" class="bg-indigo-600 text-white font-semibold px-4 py-1 text-sm rounded-lg shadow-sm hover:bg-indigo-700 transition">+ Enroll</button>
                        </h3>
                        <ul id="enrolled-students-list" class="space-y-3"></ul>
                    </div>
                </section>
            </div>
             <div id="editor-placeholder" class="lg:col-span-2 flex items-center justify-center h-96 bg-stone-50 dark:bg-slate-800/50 rounded-2xl border-2 border-dashed border-stone-300 dark:border-slate-700">
                <p class="text-gray-500 font-semibold">Select a class on the left or create a new one.</p>
            </div>
        </div>
    </main>

    <div id="enroll-student-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">Enroll Student</h2>
            <div id="all-students-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
            <button id="close-student-modal-btn" class="w-full mt-4 bg-gray-200 text-gray-800 font-semibold py-2 rounded-lg hover:bg-gray-300">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, addDoc, deleteDoc, serverTimestamp, getDocs, getDoc, query, where, orderBy, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDWpBbBLpq2fOnN5-EO3kmc0CHyG7DHXIM",
            authDomain: "elearning-e83cb.firebaseapp.com",
            projectId: "elearning-e83cb",
            storageBucket: "elearning-e83cb.appspot.com",
            messagingSenderId: "25473938624",
            appId: "1:25473938624:web:5b56738933543f32a7e925"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let activeClassId = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userDocRef);
                if (!docSnap.exists() || docSnap.data().role !== 'instructor') {
                    window.location.href = 'dashboard.html';
                } else {
                    fetchClasses(user.uid);
                    // Check for classId in URL to pre-select it
                    const urlParams = new URLSearchParams(window.location.search);
                    const classIdFromUrl = urlParams.get('classId');
                    if (classIdFromUrl) {
                        const classDocSnap = await getDoc(doc(db, "classes", classIdFromUrl));
                        if (classDocSnap.exists()) {
                            loadClassForEditing(classDocSnap.id, classDocSnap.data());
                        }
                    }
                }
            } else {
                window.location.href = 'Login.html';
            }
        });

        async function fetchClasses(instructorId) {
            const classListEl = document.getElementById('class-list');
            classListEl.innerHTML = '<p class="text-sm text-gray-500">Loading...</p>';
            const q = query(collection(db, "classes"), where("instructorId", "==", instructorId), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            
            classListEl.innerHTML = '';
            querySnapshot.forEach((doc) => {
                const classData = doc.data();
                const classEl = document.createElement('a');
                classEl.href = `#${doc.id}`;
                classEl.className = 'block p-3 rounded-lg hover:bg-stone-100 dark:hover:bg-slate-700';
                classEl.innerHTML = `<p class="font-semibold">${classData.className}</p>`;
                classEl.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('#class-list a').forEach(a => a.classList.remove('bg-indigo-100', 'dark:bg-indigo-900/50', 'border-l-4', 'border-indigo-500'));
                    classEl.classList.add('bg-indigo-100', 'dark:bg-indigo-900/50', 'border-l-4', 'border-indigo-500');
                    loadClassForEditing(doc.id, classData);
                });
                classListEl.appendChild(classEl);
            });
        }
        
        function loadClassForEditing(classId, classData) {
            activeClassId = classId;
            document.getElementById('editor-placeholder').classList.add('hidden');
            document.getElementById('editor-panel').classList.remove('hidden');
            
            document.getElementById('editor-class-id').textContent = classId;
            document.getElementById('className').value = classData.className || '';
            document.getElementById('classDescription').value = classData.description || '';
            document.getElementById('classLevel').value = classData.cefrLevel || '';
            document.getElementById('classDay').value = classData.classDay || '';
            document.getElementById('classTime').value = classData.classTime || '';
            document.getElementById('teacherName').value = classData.teacherName || '';

            const assignedLessonsList = document.getElementById('assigned-lessons-list');
            onSnapshot(query(collection(db, "classes", classId, "lessons"), orderBy("order")), (snapshot) => {
                assignedLessonsList.innerHTML = '<li><p class="text-sm text-gray-500">No lessons assigned.</p></li>';
                if(!snapshot.empty) assignedLessonsList.innerHTML = '';
                snapshot.forEach(doc => {
                    const lessonData = doc.data();
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-stone-50 dark:bg-slate-900/50 p-3 rounded-lg';
                    li.innerHTML = `<p>${lessonData.title || 'Untitled Lesson'}</p><button class="remove-lesson-btn text-red-500 text-sm font-semibold" data-lesson-id="${doc.id}">Remove</button>`;
                    li.querySelector('.remove-lesson-btn').addEventListener('click', () => {
                        if (confirm(`Are you sure you want to remove this lesson?`)) {
                            removeLessonFromClass(doc.id);
                        }
                    });
                    assignedLessonsList.appendChild(li);
                });
            });

            const enrolledStudentsList = document.getElementById('enrolled-students-list');
            onSnapshot(query(collection(db, "classes", classId, "students")), (snapshot) => {
                enrolledStudentsList.innerHTML = '<li><p class="text-sm text-gray-500">No students enrolled.</p></li>';
                if(!snapshot.empty) enrolledStudentsList.innerHTML = '';
                snapshot.forEach(studentDoc => {
                    const student = studentDoc.data();
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-stone-50 dark:bg-slate-900/50 p-3 rounded-lg';
                    li.innerHTML = `<div class="flex items-center gap-3"><img src=\"${student.photoURL || `https://ui-avatars.com/api/?name=${student.displayName}`}\" class=\"w-8 h-8 rounded-full\"><span>${student.displayName}</span></div><button class=\"unenroll-btn text-red-500 text-sm font-semibold\">Unenroll</button></li>`;
                    li.querySelector('.unenroll-btn').addEventListener('click', () => {
                        if (confirm(`Are you sure you want to unenroll ${student.displayName}?`)) {
                            unenrollStudent(studentDoc.id);
                        }
                    });
                    enrolledStudentsList.appendChild(li);
                });
            });
        }

        async function createClass() { 
            const className = prompt("Enter a name for the new class:");
            if (className) {
                const newClassData = {
                    className: className,
                    instructorId: currentUser.uid,
                    createdAt: serverTimestamp()
                };
                const docRef = await addDoc(collection(db, "classes"), newClassData);
                fetchClasses(currentUser.uid);
                loadClassForEditing(docRef.id, newClassData);
            }
        }
        
        async function saveClass(e) {
            e.preventDefault();
            const form = e.target;
            const classData = {
                className: form.className.value,
                description: form.classDescription.value,
                cefrLevel: form.classLevel.value,
                classDay: form.classDay.value,
                classTime: form.classTime.value,
                teacherName: form.teacherName.value,
                instructorId: currentUser.uid
            };
            
            try {
                if (activeClassId) {
                    await updateDoc(doc(db, "classes", activeClassId), classData);
                    alert("Class updated successfully!");
                } else {
                    alert("No class selected. Please create or select a class first.");
                }
            } catch (error) {
                console.error("Error saving class: ", error);
                alert("An error occurred while saving the class.");
            }
        }
        
        async function enrollStudentInClass(studentId, studentData) {
            if(!activeClassId) return;
            const studentInClassRef = doc(db, "classes", activeClassId, "students", studentId);
            await setDoc(studentInClassRef, { displayName: studentData.displayName, photoURL: studentData.photoURL || '' });
            const userDocRef = doc(db, "users", studentId);
            await updateDoc(userDocRef, { currentClassId: activeClassId });
        }
        
        async function unenrollStudent(studentId) {
            if (!activeClassId || !studentId) return;
            try {
                const studentInClassRef = doc(db, "classes", activeClassId, "students", studentId);
                await deleteDoc(studentInClassRef);
                const userDocRef = doc(db, "users", studentId);
                await updateDoc(userDocRef, { currentClassId: null });
                console.log(`Student ${studentId} has been unenrolled.`);
            } catch (error) {
                console.error("Error unenrolling student:", error);
            }
        }

        async function removeLessonFromClass(lessonId) {
            if (!activeClassId || !lessonId) return;
            try {
                const lessonInClassRef = doc(db, "classes", activeClassId, "lessons", lessonId);
                await deleteDoc(lessonInClassRef);
                alert("Lesson removed from class.");
            } catch (error) {
                console.error("Error removing lesson:", error);
                alert("An error occurred while removing the lesson.");
            }
        }
        
        async function deleteClass() {
            if (!activeClassId) {
                alert("Please select a class to delete.");
                return;
            }
            if (!confirm("WARNING: This will permanently delete the class and all its lessons and student data. Are you sure?")) {
                return;
            }
            try {
                const lessonsRef = collection(db, "classes", activeClassId, "lessons");
                const lessonsSnap = await getDocs(lessonsRef);
                const studentsRef = collection(db, "classes", activeClassId, "students");
                const studentsSnap = await getDocs(studentsRef);
                const discussionsRef = collection(db, "classes", activeClassId, "discussions");
                const discussionsSnap = await getDocs(discussionsRef);

                const batch = writeBatch(db);

                lessonsSnap.forEach(doc => batch.delete(doc.ref));
                studentsSnap.forEach(doc => batch.delete(doc.ref));
                discussionsSnap.forEach(doc => batch.delete(doc.ref));

                const studentsInClassQuery = query(collection(db, "users"), where("currentClassId", "==", activeClassId));
                const studentsInClassSnap = await getDocs(studentsInClassQuery);
                studentsInClassSnap.forEach(doc => {
                    batch.update(doc.ref, { currentClassId: null });
                });

                const classRef = doc(db, "classes", activeClassId);
                batch.delete(classRef);

                await batch.commit();

                alert("Class deleted successfully!");
                window.location.reload();
            } catch (error) {
                console.error("Error deleting class:", error);
                alert("An error occurred while deleting the class.");
            }
        }
        
        const enrollStudentModal = document.getElementById('enroll-student-modal');
        
        document.getElementById('class-form').addEventListener('submit', saveClass);
        document.getElementById('create-class-btn').addEventListener('click', createClass);
        document.getElementById('delete-class-btn').addEventListener('click', deleteClass);

        document.getElementById('enroll-student-btn').addEventListener('click', async () => {
            if(!activeClassId) { alert("Please select a class first."); return; }
            const list = enrollStudentModal.querySelector('#all-students-list');
            list.innerHTML = 'Loading...';
            const studentsSnap = await getDocs(query(collection(db, "users"), where("role", "==", "student")));
            list.innerHTML = '';
            studentsSnap.forEach(doc => {
                const student = doc.data();
                const btn = document.createElement('button');
                btn.className = 'w-full text-left p-2 rounded-md hover:bg-stone-100 dark:hover:bg-slate-700 flex items-center gap-3';
                btn.innerHTML = `<img src=\"${student.photoURL || `https://ui-avatars.com/api/?name=${student.displayName}`}\" class=\"w-8 h-8 rounded-full\"><span>${student.displayName}</span>`;
                btn.onclick = () => { enrollStudentInClass(doc.id, student); enrollStudentModal.classList.add('hidden'); };
                list.appendChild(btn);
            });
            enrollStudentModal.classList.remove('hidden');
        });

        document.getElementById('close-student-modal-btn').addEventListener('click', () => enrollStudentModal.classList.add('hidden'));
    </script>
</body>
</html>
