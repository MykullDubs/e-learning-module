<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 1: Prompting Fundamentals</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Theme loader script
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .flashcard-container { perspective: 1000px; cursor: pointer; }
        .flashcard { position: relative; width: 100%; height: 120px; transform-style: preserve-3d; transition: transform 0.6s; }
        .flashcard.is-flipped { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; padding: 1rem; border-radius: 0.5rem; text-align: center;}
        .flashcard-front { background-color: white; }
        .dark .flashcard-front { background-color: #374151; }
        .flashcard-back { background-color: #f3f4f6; transform: rotateY(180deg); }
        .dark .flashcard-back { background-color: #4b5563; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out, padding 0.5s ease-out; }
        .reply-indent { margin-left: 2.5rem; }
        .code-block { background-color: #1e293b; color: #e2e8f0; font-family: monospace; }
        .wireframe-box { border: 2px dashed #9ca3af; }
    </style>
</head>
<body class="bg-stone-50 dark:bg-gray-900 text-stone-800 dark:text-stone-200 transition-colors duration-300">

    <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-stone-200 dark:border-gray-700 sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 md:px-8 py-4 flex justify-between items-center">
             <a href="dashboard.html" class="text-xl font-bold text-stone-900 dark:text-white">Learning Experience Forge</a>
             <div class="flex items-center gap-6">
                 <div class="relative">
                    <button id="notifications-btn" class="relative">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-stone-500 dark:text-stone-400 hover:text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                        <span id="notifications-dot" class="hidden absolute top-0 right-0 h-2 w-2 bg-red-500 rounded-full"></span>
                    </button>
                    <div id="notifications-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-stone-200 dark:border-gray-700 overflow-hidden">
                        <div class="p-3 font-semibold text-sm border-b border-stone-200 dark:border-gray-700">Notifications</div>
                        <div id="notifications-list" class="max-h-96 overflow-y-auto"></div>
                    </div>
                 </div>
                 <div class="relative">
                    <button id="profile-btn" class="flex items-center gap-2">
                        <span id="user-email-nav" class="text-sm text-stone-600 dark:text-stone-300 hidden sm:block"></span>
                        <div id="nav-avatar-container">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-stone-400 dark:text-stone-500" fill="currentColor" viewBox="0 0 16 16"><path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/><path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/></svg>
                        </div>
                    </button>
                    <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-stone-200 dark:border-gray-700 overflow-hidden">
                        <a href="grades.html" class="block px-4 py-2 text-sm text-stone-700 dark:text-stone-200 hover:bg-stone-100 dark:hover:bg-gray-700">My Grades</a>
                        <a href="settings.html" class="block px-4 py-2 text-sm text-stone-700 dark:text-stone-200 hover:bg-stone-100 dark:hover:bg-gray-700">Settings</a>
                        <div class="border-t border-stone-200 dark:border-gray-600"></div>
                        <button id="logout-btn" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-stone-100 dark:hover:bg-gray-700">Log Out</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <header class="mb-10">
            <h1 class="text-3xl md:text-5xl font-bold text-stone-900 dark:text-white">Module 1: Prompting Fundamentals</h1>
            <p class="text-stone-500 dark:text-stone-400 mt-3 text-xl">The Art and Science of Crafting Powerful AI Instructions</p>
        </header>

        <div class="space-y-20">
            
            <section>
                <h2 class="text-2xl md:text-3xl font-bold mb-4">Part 1: The Core Components of a Great Prompt</h2>
                <p class="text-stone-600 dark:text-stone-300 mb-6">To leverage AI for rapid prototyping within the SAM model, your prompts must be clear, structured, and pedagogically sound. Think of a prompt not just as a command, but as a detailed <strong>design document</strong> you're giving to an infinitely fast developer who is also your instructional design partner. A vague idea leads to a vague prototype, wasting valuable time in your iterative cycle. A well-crafted prompt, however, can produce a surprisingly effective first version of a learning experience in minutes.</p>
                <p class="text-stone-600 dark:text-stone-300 mb-6">The synergy between <strong>Role</strong> and <strong>Task</strong> is where the magic begins. When you tell the AI to act as an <em>instructional designer</em>, you're priming it to think about learning objectives, engagement, and clarity. A simple "developer" might create a list of facts. An "instructional designer," on the other hand, will turn that list into an interactive sorting activity or a scenario-based challenge when given the right <strong>Task</strong>. This is the crucial shift from generating simple web content to prototyping genuine instructional experiences.</p>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-stone-200 dark:border-gray-700 mb-6">
                    <p class="text-stone-600 dark:text-stone-300">Consider <strong>Constraints</strong> and <strong>Details</strong> as your way of embedding learning science directly into the prototype. This is where you can be incredibly specific about the educational experience. For example, you can provide constraints like:</p>
                    <ul class="list-disc list-inside text-stone-600 dark:text-stone-300 mt-4 space-y-2">
                        <li>"The feedback for incorrect answers must be corrective and provide a hint, not just the right answer."</li>
                        <li>"Ensure the reading level is appropriate for a 9th-grade audience."</li>
                        <li>"The scenario must include a clear decision point that tests the learner's judgment."</li>
                    </ul>
                </div>
                <p class="text-stone-600 dark:text-stone-300 mb-8">Finally, the <strong>Format</strong> you request is a strategic choice that directly supports the SAM model. Asking for a "single, self-contained HTML file" is powerful because it gives you an instant, testable artifact. This isn't just a picture or a wireframe; it's a functional prototype that a learner or stakeholder can immediately interact with. This allows you to get meaningful feedback and begin the next loop of your "design, prototype, review" cycle almost immediately.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flashcard-container"><div class="flashcard"><div class="flashcard-front border-l-4 border-blue-500"><h3 class="font-bold text-2xl">Role</h3></div><div class="flashcard-back"><p>"Act as an expert instructional designer." This sets the context and influences the quality of the response.</p></div></div></div>
                    <div class="flashcard-container"><div class="flashcard"><div class="flashcard-front border-l-4 border-green-500"><h3 class="font-bold text-2xl">Task</h3></div><div class="flashcard-back"><p>"Create an interactive scenario-based quiz." This is a specific, actionable command for a learning experience.</p></div></div></div>
                    <div class="flashcard-container"><div class="flashcard"><div class="flashcard-front border-l-4 border-yellow-500"><h3 class="font-bold text-2xl">Constraints</h3></div><div class="flashcard-back"><p>"Use Tailwind CSS. The feedback must be corrective." These are the rules and pedagogical details.</p></div></div></div>
                    <div class="flashcard-container"><div class="flashcard"><div class="flashcard-front border-l-4 border-red-500"><h3 class="font-bold text-2xl">Format</h3></div><div class="flashcard-back"><p>"Provide the complete code in a single HTML file." This ensures you get a ready-to-test prototype.</p></div></div></div>
                </div>
            </section>

            <section>
                <h2 class="text-2xl md:text-3xl font-bold mb-4">Part 2: Prompting for Layout and Interactive Learning Components</h2>
                <p class="text-stone-600 dark:text-stone-300 mb-6">Once you have the structure, you can direct the AI to build specific, instructionally-sound components. Instead of just asking for a "list," you can ask for a "drag-and-drop sorting activity." Instead of a "paragraph," ask for a "scenario with a decision point." This is how you move from generating content to creating true learning interactions.</p>
                
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-stone-200 dark:border-gray-700">
                    <h3 class="font-semibold text-lg mb-4">Example 1: Scenario-Based Learning</h3>
                    <p class="text-stone-600 dark:text-stone-300 mb-6 text-sm">Let's prototype a scenario to test a learner's judgment. The prompt specifies the situation, the question, the options, and crucially, the feedback for each choice. This is a rapid way to test a learning objective.</p>
                    <div class="p-4 border border-stone-200 dark:border-gray-600 rounded-lg">
                        <div class="bg-stone-100 dark:bg-gray-700 p-4 rounded-lg mb-4">
                            <p class="font-semibold">Situation:</p>
                            <p>A customer is upset because their order was delayed. They are raising their voice. What is the best first step?</p>
                        </div>
                        <div id="scenario-options" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button class="scenario-btn p-3 bg-indigo-100 dark:bg-indigo-900/50 border border-indigo-200 dark:border-indigo-800 rounded-lg hover:bg-indigo-200 dark:hover:bg-indigo-900/80 transition" data-feedback="feedback-1">A) Tell them it's not your fault.</button>
                            <button class="scenario-btn p-3 bg-indigo-100 dark:bg-indigo-900/50 border border-indigo-200 dark:border-indigo-800 rounded-lg hover:bg-indigo-200 dark:hover:bg-indigo-900/80 transition" data-feedback="feedback-2">B) Actively listen and empathize.</button>
                            <button class="scenario-btn p-3 bg-indigo-100 dark:bg-indigo-900/50 border border-indigo-200 dark:border-indigo-800 rounded-lg hover:bg-indigo-200 dark:hover:bg-indigo-900/80 transition" data-feedback="feedback-3">C) Immediately offer a discount.</button>
                            <button class="scenario-btn p-3 bg-indigo-100 dark:bg-indigo-900/50 border border-indigo-200 dark:border-indigo-800 rounded-lg hover:bg-indigo-200 dark:hover:bg-indigo-900/80 transition" data-feedback="feedback-4">D) Ask them to calm down.</button>
                        </div>
                        <div id="feedback-container" class="mt-4">
                            <div id="feedback-1" class="hidden p-3 bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-200 rounded-lg text-sm"><strong>Incorrect:</strong> Blaming others will only escalate the situation. The first step is to de-escalate.</div>
                            <div id="feedback-2" class="hidden p-3 bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200 rounded-lg text-sm"><strong>Correct:</strong> Excellent choice. Empathizing and showing you're listening is the best way to de-escalate and begin solving the problem.</div>
                            <div id="feedback-3" class="hidden p-3 bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-200 rounded-lg text-sm"><strong>Not the best first step:</strong> While a discount might be a solution later, offering it too early can sound like a bribe and doesn't address the customer's feelings.</div>
                            <div id="feedback-4" class="hidden p-3 bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-200 rounded-lg text-sm"><strong>Incorrect:</strong> Telling someone to calm down often has the opposite effect. It's better to show them you are calm through your actions.</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section>
                <h2 class="text-2xl md:text-3xl font-bold mb-4">Part 3: Prompting for Wireframes and Storyboards</h2>
                <p class="text-stone-600 dark:text-stone-300 mb-6">Before you even think about final styling or complex interactivity, you need to structure your learning experience. This is a key part of the "Savvy Start" in the SAM model. You can use an AI to act as a UX designer, generating a low-fidelity wireframe or storyboard that helps you visualize the flow of your module. This is about planning the instructional journey, not the final look.</p>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-stone-200 dark:border-gray-700">
                    <h3 class="font-semibold text-lg mb-4">Example: Storyboarding a Simple Interaction</h3>
                    <p class="text-stone-600 dark:text-stone-300 mb-6 text-sm">Here, we'll ask the AI to create a simple visual layout for a three-step learning interaction using basic styled divs. This helps you get feedback on the flow and placement of elements before committing to a full design.</p>
                    <div class="p-4 border border-stone-200 dark:border-gray-600 rounded-lg">
                        <div class="bg-stone-100 dark:bg-gray-700 p-4 rounded-lg">
                            <div class="wireframe-box p-4 bg-white dark:bg-gray-800 rounded mb-4">
                                <h4 class="font-bold text-center">Step 1: Introduction</h4>
                                <div class="wireframe-box h-24 mt-2 flex items-center justify-center text-sm text-stone-500">Video Element</div>
                                <p class="text-xs text-center mt-2 text-stone-500">Brief introductory text explaining the concept.</p>
                            </div>
                            <div class="text-center text-2xl text-stone-400">↓</div>
                             <div class="wireframe-box p-4 bg-white dark:bg-gray-800 rounded my-4">
                                <h4 class="font-bold text-center">Step 2: Knowledge Check</h4>
                                <div class="wireframe-box h-12 mt-2 flex items-center justify-center text-sm text-stone-500">Multiple Choice Question</div>
                                <div class="grid grid-cols-2 gap-2 mt-2">
                                    <div class="wireframe-box h-8 text-xs flex items-center justify-center text-stone-500">Option A</div>
                                    <div class="wireframe-box h-8 text-xs flex items-center justify-center text-stone-500">Option B</div>
                                </div>
                            </div>
                            <div class="text-center text-2xl text-stone-400">↓</div>
                             <div class="wireframe-box p-4 bg-white dark:bg-gray-800 rounded mt-4">
                                <h4 class="font-bold text-center">Step 3: Feedback</h4>
                                <p class="text-xs text-center mt-2 text-stone-500">A text block that provides corrective feedback based on the user's answer in Step 2.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section>
                <h2 class="text-2xl md:text-3xl font-bold mb-4">Part 4: Prompting for Interactivity with JavaScript</h2>
                <p class="text-stone-600 dark:text-stone-300 mb-6">This is where the magic of the SAM model comes alive. By prompting for JavaScript, you can create functional, testable prototypes of learning games, simulations, and other complex interactions in a fraction of the time it would take to build them manually.</p>
                
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-stone-200 dark:border-gray-700 mb-8">
                    <h3 class="font-semibold text-lg mb-4">Example 1: A "Click to Reveal" Interaction</h3>
                    <p class="text-stone-600 dark:text-stone-300 mb-6 text-sm">This is a simple but effective way to create a layered learning experience, where the learner can self-test their knowledge before revealing the answer. The prompt needs to specify the target element, the event (a 'click'), and the action (toggling visibility).</p>
                    <div class="p-4 border border-stone-200 dark:border-gray-600 rounded-lg">
                        <button id="reveal-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">What is the core loop of the SAM model?</button>
                        <div id="reveal-content" class="hidden mt-4 p-4 bg-stone-100 dark:bg-gray-700 rounded-lg">
                            <p>The core loop of the SAM model is: <strong>Design, Prototype, and Review</strong>. This iterative process allows for rapid development and continuous improvement.</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-stone-200 dark:border-gray-700">
                    <h3 class="font-semibold text-lg mb-4">Example 2: Gamified Mini-Quiz - The Prompt-Tuning Simulator</h3>
                    <p class="text-stone-600 dark:text-stone-300 mb-6 text-sm">This is an authentic assessment where you practice the skill of prompt refinement. Your goal is to edit the vague prompt below to include all four key components. The AI simulator will give you feedback based on your input.</p>
                    <div class="p-4 border border-stone-200 dark:border-gray-600 rounded-lg">
                        <label for="prompt-input" class="block font-semibold mb-2">Your Prompt:</label>
                        <textarea id="prompt-input" class="w-full h-32 p-2 border border-stone-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">Make an interactive learning thing about history.</textarea>
                        <button id="submit-prompt-btn" class="mt-4 px-5 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">Submit to AI Simulator</button>
                        <div id="prompt-feedback" class="mt-4 p-3 rounded-lg bg-stone-100 dark:bg-gray-700 hidden">
                           <!-- JS will populate this -->
                        </div>
                    </div>
                </div>
            </section>
        </div>
        
        <section class="mt-20">
            <button id="toggle-discussion-btn-bottom" class="w-full flex justify-between items-center p-4 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-stone-200 dark:border-gray-700">
                <h2 class="text-xl font-bold">Module Discussion</h2>
                <svg id="discussion-arrow-bottom" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
            </button>
            <div id="discussion-content-bottom" class="accordion-content">
                <div id="discussions-container-bottom" class="space-y-8 pt-4">
                     <div id="loading-state-bottom" class="text-center py-12">
                        <p class="text-stone-500 dark:text-stone-400">Loading discussion...</p>
                    </div>
                </div>
            </div>
        </section>

         <section class="text-center py-10 border-t border-stone-200 dark:border-gray-700 mt-16">
             <a href="fa1.html" class="px-8 py-4 bg-indigo-800 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-900 transition text-lg">
                Take Summative Assessment
            </a>
        </section>
    </main>

     <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, collection, query, where, onSnapshot, orderBy, writeBatch, addDoc, serverTimestamp, getDocs, deleteDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const moduleIdToLoad = 'module1';

        const firebaseConfig = {
            apiKey: "AIzaSyDWpBbBLpq2fOnN5-EO3kmc0CHyG7DHXIM",
            authDomain: "elearning-e83cb.firebaseapp.com",
            projectId: "elearning-e83cb",
            storageBucket: "elearning-e83cb.appspot.com",
            messagingSenderId: "25473938624",
            appId: "1:25473938624:web:5b56738933543f32a7e925",
            measurementId: "G-R713G5DD1S"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let unsubscribeNotifications = null;

        // --- All Element Declarations ---
        const logoutBtn = document.getElementById('logout-btn');
        const profileBtn = document.getElementById('profile-btn');
        const profileDropdown = document.getElementById('profile-dropdown');
        const notificationsBtn = document.getElementById('notifications-btn');
        const notificationsDropdown = document.getElementById('notifications-dropdown');
        const notificationsDot = document.getElementById('notifications-dot');
        const notificationsList = document.getElementById('notifications-list');
        const toggleDiscussionBtn = document.getElementById('toggle-discussion-btn-bottom');
        const discussionContent = document.getElementById('discussion-content-bottom');
        const discussionArrow = document.getElementById('discussion-arrow-bottom');
        const discussionsContainer = document.getElementById('discussions-container-bottom');
        const flashcards = document.querySelectorAll('.flashcard');
        const scenarioBtns = document.querySelectorAll('.scenario-btn');
        const feedbackContainer = document.getElementById('feedback-container');
        const revealBtn = document.getElementById('reveal-btn');
        const revealContent = document.getElementById('reveal-content');
        const promptInput = document.getElementById('prompt-input');
        const submitPromptBtn = document.getElementById('submit-prompt-btn');
        const promptFeedback = document.getElementById('prompt-feedback');

        // --- Event Listeners ---
        profileBtn.addEventListener('click', (e) => { e.stopPropagation(); profileDropdown.classList.toggle('hidden'); notificationsDropdown.classList.add('hidden'); });
        notificationsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            profileDropdown.classList.add('hidden');
            notificationsDropdown.classList.toggle('hidden');
            if (!notificationsDropdown.classList.contains('hidden')) markNotificationsAsRead();
        });
        window.addEventListener('click', () => {
            profileDropdown.classList.add('hidden');
            notificationsDropdown.classList.add('hidden');
        });
        logoutBtn.addEventListener('click', () => {
            if (unsubscribeNotifications) unsubscribeNotifications();
            signOut(auth);
        });

        toggleDiscussionBtn.addEventListener('click', () => {
            const isExpanded = discussionContent.style.maxHeight && discussionContent.style.maxHeight !== '0px';
            if (isExpanded) {
                discussionContent.style.maxHeight = '0px';
                discussionContent.style.paddingTop = '0';
                discussionArrow.style.transform = 'rotate(0deg)';
            } else {
                discussionContent.style.maxHeight = discussionContent.scrollHeight + "px";
                discussionContent.style.paddingTop = '1rem';
                discussionArrow.style.transform = 'rotate(180deg)';
            }
        });

        flashcards.forEach(card => card.addEventListener('click', () => card.classList.toggle('is-flipped')));
        
        scenarioBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const feedbackId = btn.dataset.feedback;
                feedbackContainer.querySelectorAll('div').forEach(div => div.classList.add('hidden'));
                document.getElementById(feedbackId).classList.remove('hidden');
            });
        });

        revealBtn.addEventListener('click', () => revealContent.classList.toggle('hidden'));
        
        submitPromptBtn.addEventListener('click', () => {
            const text = promptInput.value.toLowerCase();
            let score = 0;
            let feedbackText = '<ul>';
            if (text.includes('act as') || text.includes('you are a')) { score++; feedbackText += '<li class="text-green-600 dark:text-green-400">✅ Great! You\'ve given the AI a <strong>Role</strong>.</li>'; } else { feedbackText += '<li class="text-red-600 dark:text-red-400">❌ Needs a <strong>Role</strong>. Try adding "Act as an instructional designer."</li>'; }
            if (text.includes('create') || text.includes('build') || text.includes('generate')) { score++; feedbackText += '<li class="text-green-600 dark:text-green-400">✅ Excellent! You\'ve defined a clear <strong>Task</strong>.</li>'; } else { feedbackText += '<li class="text-red-600 dark:text-red-400">❌ Needs a specific <strong>Task</strong>. What should the AI do?</li>'; }
            if (text.includes('tailwind') || text.includes('interactive') || text.includes('feedback')) { score++; feedbackText += '<li class="text-green-600 dark:text-green-400">✅ Good job adding <strong>Constraints & Details</strong>.</li>'; } else { feedbackText += '<li class="text-red-600 dark:text-red-400">❌ Needs <strong>Constraints</strong>. What technology should it use?</li>'; }
            if (text.includes('html') || text.includes('single file')) { score++; feedbackText += '<li class="text-green-600 dark:text-green-400">✅ Perfect! You\'ve specified the output <strong>Format</strong>.</li>'; } else { feedbackText += '<li class="text-red-600 dark:text-red-400">❌ Needs a <strong>Format</strong>. How should the AI deliver the code?</li>'; }
            if (score === 4) { feedbackText += '<p class="font-bold mt-2">This is a high-quality prompt!</p>'; }
            feedbackText += '</ul>';
            promptFeedback.innerHTML = feedbackText;
            promptFeedback.classList.remove('hidden');
        });

        discussionsContainer.addEventListener('click', async (e) => {
            const postId = e.target.dataset.postId;
            if (!postId) return;

            if (e.target.classList.contains('delete-btn')) {
                if (confirm('Are you sure you want to delete this post?')) {
                    await deleteDoc(doc(db, "discussions", postId));
                }
            } else if (e.target.classList.contains('edit-btn')) {
                document.getElementById(`post-text-${postId}`).classList.add('hidden');
                const editForm = document.getElementById(`edit-form-${postId}`);
                editForm.classList.remove('hidden');
                editForm.querySelector('textarea').value = document.getElementById(`post-text-${postId}`).textContent;
            } else if (e.target.classList.contains('cancel-edit-btn')) {
                 document.getElementById(`post-text-${postId}`).classList.remove('hidden');
                 document.getElementById(`edit-form-${postId}`).classList.add('hidden');
            } else if (e.target.classList.contains('save-btn')) {
                const newText = document.getElementById(`edit-form-${postId}`).querySelector('textarea').value;
                if(newText) {
                    await updateDoc(doc(db, "discussions", postId), { text: newText });
                    document.getElementById(`post-text-${postId}`).classList.remove('hidden');
                    document.getElementById(`edit-form-${postId}`).classList.add('hidden');
                }
            } else if (e.target.classList.contains('reply-btn')) {
                handleReply(e);
            }
        });

        // --- Main Auth Function ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-email-nav').textContent = user.email;
                const navAvatarContainer = document.getElementById('nav-avatar-container');
                if (user.photoURL) {
                   navAvatarContainer.innerHTML = `<img src="${user.photoURL}" class="w-8 h-8 rounded-full object-cover">`;
                }
                listenForNotifications(user.uid);
                fetchDiscussions();
            } else {
                window.location.href = '/Login.html';
            }
        });
        
        // --- Reusable Functions ---
        function listenForNotifications(userId) {
            const notificationsRef = collection(db, "notifications", userId, "userNotifications");
            const q = query(notificationsRef, orderBy("createdAt", "desc"));
            unsubscribeNotifications = onSnapshot(q, (snapshot) => {
                let unreadIds = [];
                notificationsList.innerHTML = '';
                if (snapshot.empty) {
                    notificationsList.innerHTML = `<p class="p-4 text-sm text-stone-500 dark:text-stone-400">No new notifications.</p>`;
                    notificationsDot.classList.add('hidden');
                    return;
                }
                let hasUnread = false;
                snapshot.forEach(doc => {
                    const notification = { id: doc.id, ...doc.data() };
                    if (!notification.isRead) { hasUnread = true; unreadIds.push(doc.id); }
                    displayNotification(notification);
                });
                notificationsDot.style.display = hasUnread ? 'block' : 'none';
            });
        }
        function displayNotification(notification) {
            const div = document.createElement('a');
            div.href = notification.link || '#';
            div.className = `block px-4 py-3 border-b border-stone-100 dark:border-gray-700 hover:bg-stone-50 dark:hover:bg-gray-700 ${!notification.isRead ? 'bg-indigo-50 dark:bg-indigo-900/20' : ''}`;
            const timeAgo = formatTimeAgo(notification.createdAt.toDate());
            div.innerHTML = `<p class="text-sm font-medium">${notification.message}</p><p class="text-xs text-stone-500 dark:text-stone-400 mt-1">${timeAgo}</p>`;
            notificationsList.appendChild(div);
        }
        async function markNotificationsAsRead() {
            if (!currentUser) return;
            const unreadIds = [];
            const notificationsRef = collection(db, "notifications", currentUser.uid, "userNotifications");
            const q = query(notificationsRef, where("isRead", "==", false));
            const snapshot = await getDocs(q);
            snapshot.forEach(doc => unreadIds.push(doc.id));

            if (unreadIds.length === 0) return;
            const batch = writeBatch(db);
            unreadIds.forEach(id => {
                const notifRef = doc(db, "notifications", currentUser.uid, "userNotifications", id);
                batch.update(notifRef, { isRead: true });
            });
            await batch.commit();
        }
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60; if (interval > 1) return Math.floor(interval) + " minutes ago";
            return Math.floor(seconds) + " seconds ago";
        }
        
        function fetchDiscussions() {
            const q = query(collection(db, "discussions"), where("isParent", "==", true), where("moduleId", "==", moduleIdToLoad), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                document.getElementById('loading-state')?.remove();
                if (snapshot.empty) {
                    discussionsContainer.innerHTML = '<p class="text-center text-stone-500 dark:text-stone-400">No discussion has been started for this module yet.</p>';
                    return;
                }
                discussionsContainer.innerHTML = '';
                snapshot.forEach(doc => renderParentPost(doc.id, doc.data()));
            });
        }
        function renderParentPost(postId, postData) {
            const threadContainer = document.createElement('div');
            threadContainer.className = 'bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-stone-200 dark:border-gray-700';
            const time = postData.createdAt ? formatTimeAgo(postData.createdAt.toDate()) : 'just now';
            
            let editDeleteControls = '';
            if (currentUser && postData.authorId === currentUser.uid) {
                editDeleteControls = `
                    <div class="ml-auto flex items-center gap-3">
                        <button class="edit-btn text-xs text-stone-500 dark:text-stone-400 hover:text-indigo-600" data-post-id="${postId}">Edit</button>
                        <button class="delete-btn text-xs text-stone-500 dark:text-stone-400 hover:text-red-600" data-post-id="${postId}">Delete</button>
                    </div>
                `;
            }

            threadContainer.innerHTML = `
                <div class="flex items-start gap-4">
                    <div class="w-10 h-10 bg-indigo-100 dark:bg-indigo-900 rounded-full flex items-center justify-center font-bold text-indigo-600 dark:text-indigo-300 text-lg flex-shrink-0">
                        ${postData.authorName.charAt(0)}
                    </div>
                    <div class="flex-grow">
                        <div class="flex items-center gap-3">
                            <p class="font-semibold">${postData.authorName}</p>
                            <p class="text-xs text-stone-500 dark:text-stone-400">${time}</p>
                            ${editDeleteControls}
                        </div>
                        <div id="post-text-${postId}" class="mt-2 text-stone-700 dark:text-stone-300">${postData.text}</div>
                        <div id="edit-form-${postId}" class="hidden mt-2">
                            <textarea class="w-full p-2 border border-stone-300 rounded-md dark:bg-gray-700 dark:border-gray-600 text-sm">${postData.text}</textarea>
                            <div class="flex gap-2 mt-2">
                                <button class="save-btn text-xs px-3 py-1 bg-green-600 text-white rounded" data-post-id="${postId}">Save</button>
                                <button class="cancel-edit-btn text-xs px-3 py-1 bg-stone-200 dark:bg-gray-600 rounded" data-post-id="${postId}">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="replies-${postId}" class="mt-4 space-y-4 reply-indent"></div>
                <div class="mt-4 reply-indent">
                    <div class="flex items-center gap-2">
                         <input type="text" id="reply-input-${postId}" class="w-full bg-stone-100 dark:bg-gray-700 border-stone-200 dark:border-gray-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Write a reply...">
                         <button data-post-id="${postId}" data-author-id="${postData.authorId}" class="reply-btn px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg text-sm hover:bg-indigo-700 transition">Reply</button>
                    </div>
                </div>
            `;
            discussionsContainer.appendChild(threadContainer);
            fetchReplies(postId);
        }
        
        function fetchReplies(parentId) {
            const q = query(collection(db, "discussions"), where("parentId", "==", parentId), orderBy("createdAt", "asc"));
            onSnapshot(q, (snapshot) => {
                const repliesContainer = document.getElementById(`replies-${parentId}`);
                if (!repliesContainer) return;
                repliesContainer.innerHTML = '';
                snapshot.forEach(doc => renderReply(repliesContainer, doc.id, doc.data()));
            });
        }
        
        function renderReply(container, replyId, replyData) {
             const replyDiv = document.createElement('div');
             replyDiv.className = 'flex items-start gap-4';
             const time = replyData.createdAt ? formatTimeAgo(replyData.createdAt.toDate()) : 'just now';
             const initial = replyData.authorName.charAt(0);
             
             let editDeleteControls = '';
             if (currentUser && replyData.authorId === currentUser.uid) {
                editDeleteControls = `
                    <div class="ml-auto flex items-center gap-2">
                        <button class="edit-btn text-xs text-stone-500 dark:text-stone-400 hover:text-indigo-600" data-post-id="${replyId}">Edit</button>
                        <button class="delete-btn text-xs text-stone-500 dark:text-stone-400 hover:text-red-600" data-post-id="${replyId}">Delete</button>
                    </div>
                `;
             }

             replyDiv.innerHTML = `
                <div class="w-8 h-8 bg-stone-100 dark:bg-gray-700 rounded-full flex items-center justify-center font-bold text-sm flex-shrink-0">
                    ${initial}
                </div>
                <div class="flex-grow">
                    <div class="flex items-center gap-3">
                        <p class="font-semibold text-sm">${replyData.authorName}</p>
                        <p class="text-xs text-stone-500 dark:text-stone-400">${time}</p>
                        ${editDeleteControls}
                    </div>
                    <div id="post-text-${replyId}" class="mt-1 text-sm text-stone-700 dark:text-stone-300">${replyData.text}</div>
                    <div id="edit-form-${replyId}" class="hidden mt-2">
                        <textarea class="w-full p-2 border border-stone-300 rounded-md dark:bg-gray-700 dark:border-gray-600 text-sm">${replyData.text}</textarea>
                        <div class="flex gap-2 mt-2">
                            <button class="save-btn text-xs px-3 py-1 bg-green-600 text-white rounded" data-post-id="${replyId}">Save</button>
                            <button class="cancel-edit-btn text-xs px-3 py-1 bg-stone-200 dark:bg-gray-600 rounded" data-post-id="${replyId}">Cancel</button>
                        </div>
                    </div>
                </div>
             `;
             container.appendChild(replyDiv);
        }

        async function handleReply(event) {
            const parentId = event.target.dataset.postId;
            const originalPosterId = event.target.dataset.authorId;
            const input = document.getElementById(`reply-input-${parentId}`);
            const text = input.value.trim();
            if (!text || !currentUser) return;
            event.target.disabled = true;
            await addDoc(collection(db, "discussions"), {
                authorId: currentUser.uid,
                authorName: currentUser.displayName || currentUser.email,
                isParent: false,
                parentId: parentId,
                text: text,
                createdAt: serverTimestamp()
            });
            input.value = '';
            event.target.disabled = false;
            if (originalPosterId && originalPosterId !== currentUser.uid) {
                createNotification(originalPosterId, `${currentUser.displayName || 'A student'} replied to your post.`);
            }
        }
        
        async function createNotification(userId, message) {
            if (!userId) return;
            await addDoc(collection(db, "notifications", userId, "userNotifications"), {
                message: message, isRead: false, createdAt: serverTimestamp(), link: `/module1.html`
            });
        }
     </script>
</body>
</html>

